<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoveyoTech | Client Management Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCW5Fjn6qM9a2XVoLwnZ1aE_J3eWP8heg0",
            authDomain: "noveyo-client-dashboard.firebaseapp.com",
            projectId: "noveyo-client-dashboard",
            storageBucket: "noveyo-client-dashboard.firebasestorage.app",
            messagingSenderId: "969420186345",
            appId: "1:969420186345:web:71e82466c77053b82f0678"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions available globally
        window.db = db;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.collection = collection;
    </script>
    <style>
        :root {
            --primary: #060644;
            --secondary: #41c1ba;
            --dark: #2C3E50;
            --light: #F8F9FA;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --gray: #6C757D;
            --light-gray: #E9ECEF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #F5F7FB;
            color: var(--dark);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--dark);
            color: white;
            padding: 20px 0;
            transition: all 0.3s;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .logo h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo h1 i {
            color: var(--primary);
        }
        
        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5752d6;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        
        table th {
            font-weight: 600;
            color: var(--gray);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .status-closed {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Charts */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            height: 400px;
            position: relative;
        }
        
        .chart-card canvas {
            max-height: 300px;
            width: 100% !important;
            height: 300px !important;
        }
        
        @media (max-width: 992px) {
            .chart-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Utilities */
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-10 { gap: 10px; }
        
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        
        /* Mobile Toggle Button */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .mobile-toggle:hover {
            background: #5a52ff;
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
            }
            
            .sidebar {
                width: 280px;
                position: fixed;
                top: 0;
                left: -280px;
                z-index: 1000;
                transition: left 0.3s ease;
                height: 100vh;
                overflow-y: auto;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 60px 15px 20px;
                width: 100%;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .d-flex {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card h3 {
                font-size: 18px;
            }
            
            .chart-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .chart-card {
                width: 100%;
                padding: 15px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .card-header {
                padding: 15px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-control {
                padding: 10px;
                font-size: 14px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 14px;
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .analytics-tab-content {
                padding: 15px;
            }
            
            .row {
                margin: 0;
            }
            
            .col-md-6 {
                width: 100%;
                padding: 0;
                margin-bottom: 15px;
            }
            
            /* Payment tracking mobile styles */
            #paymentTracking {
                padding: 10px;
            }
            
            #paymentTracking .form-control {
                margin-bottom: 10px;
            }
            
            /* Service type management mobile */
            .service-type-form {
                flex-direction: column;
                gap: 10px;
            }
            
            .service-type-form .form-control {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 60px 10px 20px;
            }
            
            .stats-container {
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card h3 {
                font-size: 16px;
            }
            
            .stat-card p {
                font-size: 12px;
            }
            
            .card-header h2 {
                font-size: 18px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .form-control {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeSidebar()"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1><img src="logo.png" alt="Company Logo" style="height: 75px; width: auto; display: block; margin: 0 auto;"></h1>
        </div>
        <div class="menu-item active">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </div>
        <div class="menu-item">
            <i class="fas fa-users"></i>
            <span>Clients</span>
        </div>
        <div class="menu-item">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Projects</span>
        </div>
        <div class="menu-item">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
        </div>
        <div class="menu-item">
            <i class="fas fa-handshake"></i>
            <span>Outreach</span>
        </div>
        <div class="menu-item">
            <i class="fas fa-file-invoice"></i>
            <span>Invoices</span>
        </div>
        <div class="menu-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1 class="page-title">Dashboard</h1>
            <div class="d-flex align-center gap-10">
                <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                    <input type="text" class="form-control" placeholder="Search...">
                </div>
                <button class="btn btn-primary"><i class="fas fa-plus"></i> New Client</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(108, 99, 255, 0.1); color: var(--primary);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-info">
                    <h3>$24,560</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(78, 205, 196, 0.1); color: var(--secondary);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>42</h3>
                    <p>Active Clients</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning);">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="stat-info">
                    <h3>18</h3>
                    <p>Ongoing Projects</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(220, 53, 69, 0.1); color: var(--danger);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3>7</h3>
                    <p>Pending Proposals</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active">Client Management</div>
            <div class="tab">Revenue Analytics</div>
            <div class="tab">Outreach Tracking</div>
        </div>

        <!-- Client Management -->
        <div class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Add New Client</h2>
                </div>
                <form>
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" class="form-control" id="clientName" placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Email Address</label>
                        <input type="email" class="form-control" id="clientEmail" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label for="serviceType">Service Type</label>
                        <select class="form-control" id="serviceType">
                            <option value="">Select service type</option>
                            <option value="logo">Logo Design</option>
                            <option value="branding">Branding Package</option>
                            <option value="web">Web Design</option>
                            <option value="social">Social Media Graphics</option>
                            <option value="print">Print Design</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Engagement Type</label>
                        <div>
                            <input type="radio" id="contract" name="engagementType" value="contract">
                            <label for="contract">Contract</label>
                            <input type="radio" id="onetime" name="engagementType" value="onetime" style="margin-left: 15px;">
                            <label for="onetime">One-Time</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="projectValue">Project Value</label>
                        <input type="number" class="form-control" id="projectValue" placeholder="Enter amount">
                    </div>
                    <div class="form-group">
                        <label for="depositPaid">Deposit Paid</label>
                        <select class="form-control" id="depositPaid">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Client</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Current Clients</h2>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Service</th>
                                <th>Type</th>
                                <th>Value</th>
                                        <th>Payment Status</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sarah Johnson</td>
                                <td>Branding Package</td>
                                <td>Contract</td>
                                <td>$4,500</td>
                                <td class="text-success">Paid</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>
                                    <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;"></i>
                                    <i class="fas fa-trash" style="color: var(--danger); cursor: pointer; margin-left: 10px;"></i>
                                </td>
                            </tr>
                            <tr>
                                <td>TechStart Inc.</td>
                                <td>Web Design</td>
                                <td>Contract</td>
                                <td>$7,200</td>
                                <td class="text-success">Paid</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>
                                    <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;"></i>
                                    <i class="fas fa-trash" style="color: var(--danger); cursor: pointer; margin-left: 10px;"></i>
                                </td>
                            </tr>
                            <tr>
                                <td>Local Cafe</td>
                                <td>Logo Design</td>
                                <td>One-Time</td>
                                <td>$800</td>
                                <td class="text-warning">Pending</td>
                                <td><span class="status-badge status-pending">Proposal Sent</span></td>
                                <td>
                                    <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;"></i>
                                    <i class="fas fa-trash" style="color: var(--danger); cursor: pointer; margin-left: 10px;"></i>
                                </td>
                            </tr>
                            <tr>
                                <td>Fitness First</td>
                                <td>Social Media Graphics</td>
                                <td>Contract</td>
                                <td>$2,400</td>
                                <td class="text-success">Paid</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>
                                    <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;"></i>
                                    <i class="fas fa-trash" style="color: var(--danger); cursor: pointer; margin-left: 10px;"></i>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Revenue Analytics -->
        <div class="tab-content">
            <div class="chart-container">
                <div class="chart-card">
                    <h2 class="card-title mb-20">Revenue by Service Type</h2>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2 class="card-title mb-20">Monthly Revenue</h2>
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
            </div>
            
            <div class="card mt-20">
                <div class="card-header">
                    <h2 class="card-title">Revenue Summary</h2>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Service Type</th>
                                <th>Number of Projects</th>
                                <th>Total Revenue</th>
                                <th>Average Project Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Logo Design</td>
                                <td>12</td>
                                <td>$9,600</td>
                                <td>$800</td>
                            </tr>
                            <tr>
                                <td>Branding Package</td>
                                <td>8</td>
                                <td>$28,500</td>
                                <td>$3,562</td>
                            </tr>
                            <tr>
                                <td>Web Design</td>
                                <td>5</td>
                                <td>$31,200</td>
                                <td>$6,240</td>
                            </tr>
                            <tr>
                                <td>Social Media Graphics</td>
                                <td>15</td>
                                <td>$12,000</td>
                                <td>$800</td>
                            </tr>
                            <tr>
                                <td>Print Design</td>
                                <td>7</td>
                                <td>$8,400</td>
                                <td>$1,200</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Outreach Tracking -->
        <div class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Add New Prospect</h2>
                </div>
                <form>
                    <div class="form-group">
                        <label for="prospectName">Prospect Name</label>
                        <input type="text" class="form-control" id="prospectName" placeholder="Enter prospect name">
                    </div>
                    <div class="form-group">
                        <label for="prospectCompany">Company</label>
                        <input type="text" class="form-control" id="prospectCompany" placeholder="Enter company name">
                    </div>
                    <div class="form-group">
                        <label for="prospectEmail">Email Address</label>
                        <input type="email" class="form-control" id="prospectEmail" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label for="prospectPhone">Phone Number</label>
                        <input type="tel" class="form-control" id="prospectPhone" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label for="proposedService">Proposed Service</label>
                        <select class="form-control" id="proposedService">
                            <option value="">Select service type</option>
                            <option value="logo">Logo Design</option>
                            <option value="branding">Branding Package</option>
                            <option value="web">Web Design</option>
                            <option value="social">Social Media Graphics</option>
                            <option value="print">Print Design</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Prospect</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Prospect Pipeline</h2>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Prospect</th>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Proposed Service</th>
                                <th>Proposal Sent</th>
                                <th>Response</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Michael Roberts</td>
                                <td>GreenTech Solutions</td>
                                <td>michael@greentech.com</td>
                                <td>Web Design</td>
                                <td>2023-06-15</td>
                                <td>Positive</td>
                                <td><span class="status-badge status-active">Follow-up Scheduled</span></td>
                            </tr>
                            <tr>
                                <td>Jennifer Lee</td>
                                <td>Fashion Boutique</td>
                                <td>jennifer@fboutique.com</td>
                                <td>Branding Package</td>
                                <td>2023-06-20</td>
                                <td>No Response</td>
                                <td><span class="status-badge status-pending">Awaiting Response</span></td>
                            </tr>
                            <tr>
                                <td>David Wilson</td>
                                <td>Wilson Legal</td>
                                <td>david@wilsonlegal.com</td>
                                <td>Logo Design</td>
                                <td>2023-06-10</td>
                                <td>Negative</td>
                                <td><span class="status-badge status-closed">Not Interested</span></td>
                            </tr>
                            <tr>
                                <td>Emily Chen</td>
                                <td>StartUp Innovate</td>
                                <td>emily@startupinnovate.com</td>
                                <td>Social Media Graphics</td>
                                <td>2023-06-18</td>
                                <td>Positive</td>
                                <td><span class="status-badge status-active">Meeting Scheduled</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('JavaScript is loading...');
        
        // Global data storage
        let clients = JSON.parse(localStorage.getItem('clients')) || [
            {
                id: 1,
                name: 'Sarah Johnson',
                email: 'sarah@example.com',
                phone: '+254 700 123 456',
                service: 'Branding Package',
                type: 'Contract',
                contractDuration: 'monthly',
                value: 4500,
                paymentStatus: 'fully-paid',
                paidAmount: 4500,
                status: 'Active',
                monthlyPayments: [
                    { date: '2023-06-01', amount: 1500 },
                    { date: '2023-07-01', amount: 1500 },
                    { date: '2023-08-01', amount: 1500 }
                ]
            },
            {
                id: 2,
                name: 'TechStart Inc.',
                email: 'contact@techstart.com',
                phone: '+254 700 234 567',
                service: 'Web Design',
                type: 'Contract',
                contractDuration: 'quarterly',
                value: 7200,
                paymentStatus: 'deposit',
                paidAmount: 3600,
                status: 'Active',
                monthlyPayments: [
                    { date: '2023-06-01', amount: 3600 }
                ]
            },
            {
                id: 3,
                name: 'Local Cafe',
                email: 'owner@localcafe.com',
                phone: '+254 700 345 678',
                service: 'Logo Design',
                type: 'One-Time',
                contractDuration: null,
                value: 800,
                paymentStatus: 'deposit',
                paidAmount: 400,
                status: 'Paused',
                monthlyPayments: []
            },
            {
                id: 4,
                name: 'Fitness First',
                email: 'manager@fitnessfirst.com',
                phone: '+254 700 456 789',
                service: 'Social Media Graphics',
                type: 'Contract',
                contractDuration: 'weekly',
                value: 2400,
                paymentStatus: 'fully-paid',
                paidAmount: 2400,
                status: 'Active',
                monthlyPayments: [
                    { date: '2023-06-01', amount: 600 },
                    { date: '2023-06-08', amount: 600 },
                    { date: '2023-06-15', amount: 600 },
                    { date: '2023-06-22', amount: 600 }
                ]
            }
        ];

        let prospects = JSON.parse(localStorage.getItem('prospects')) || [
            {
                id: 1,
                name: 'Michael Roberts',
                company: 'GreenTech Solutions',
                email: 'michael@greentech.com',
                phone: '(555) 123-4567',
                service: 'Web Design',
                proposalSent: '2023-06-15',
                response: 'Positive',
                status: 'Follow-up Scheduled'
            },
            {
                id: 2,
                name: 'Jennifer Lee',
                company: 'Fashion Boutique',
                email: 'jennifer@fboutique.com',
                phone: '(555) 234-5678',
                service: 'Branding Package',
                proposalSent: '2023-06-20',
                response: 'No Response',
                status: 'Awaiting Response'
            },
            {
                id: 3,
                name: 'David Wilson',
                company: 'Wilson Legal',
                email: 'david@wilsonlegal.com',
                phone: '(555) 345-6789',
                service: 'Logo Design',
                proposalSent: '2023-06-10',
                response: 'Negative',
                status: 'Not Interested'
            },
            {
                id: 4,
                name: 'Emily Chen',
                company: 'StartUp Innovate',
                email: 'emily@startupinnovate.com',
                phone: '(555) 456-7890',
                service: 'Social Media Graphics',
                proposalSent: '2023-06-18',
                response: 'Positive',
                status: 'Meeting Scheduled'
            }
        ];

        let projects = JSON.parse(localStorage.getItem('projects')) || [
            {
                id: 1,
                clientId: 1,
                clientName: 'Sarah Johnson',
                projectName: 'Complete Brand Identity Package',
                service: 'Branding Package',
                status: 'In Progress',
                startDate: '2023-06-01',
                dueDate: '2023-07-15',
                progress: 65,
                value: 4500,
                description: 'Complete brand identity including logo, business cards, letterhead, and brand guidelines'
            },
            {
                id: 2,
                clientId: 2,
                clientName: 'TechStart Inc.',
                projectName: 'Corporate Website Redesign',
                service: 'Web Design',
                status: 'In Progress',
                startDate: '2023-06-10',
                dueDate: '2023-08-01',
                progress: 40,
                value: 7200,
                description: 'Complete website redesign with modern UI/UX and responsive design'
            },
            {
                id: 3,
                clientId: 3,
                clientName: 'Local Cafe',
                projectName: 'Logo Design & Business Cards',
                service: 'Logo Design',
                status: 'Not Started',
                startDate: '2023-07-01',
                dueDate: '2023-07-20',
                progress: 0,
                value: 800,
                description: 'Logo design and business card layout for local cafe'
            },
            {
                id: 4,
                clientId: 4,
                clientName: 'Fitness First',
                projectName: 'Monthly Social Media Graphics',
                service: 'Social Media Graphics',
                status: 'Completed',
                startDate: '2023-05-01',
                dueDate: '2023-06-30',
                progress: 100,
                value: 2400,
                description: 'Monthly social media graphics package for fitness center'
            }
        ];

        let invoices = [];
        
        // Firebase sync settings
        let autoSyncEnabled = false;


        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('clients', JSON.stringify(clients));
                localStorage.setItem('prospects', JSON.stringify(prospects));
                localStorage.setItem('projects', JSON.stringify(projects));
                localStorage.setItem('invoices', JSON.stringify(invoices));
                console.log('Data saved to localStorage');
                
                // Optional: Sync to Firebase if auto-sync is enabled
                if (window.db && autoSyncEnabled) {
                    console.log('Auto-sync enabled, syncing to Firebase...');
                    syncToFirebase();
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Optional Firebase sync functions (non-blocking)
        async function syncToFirebase() {
            try {
                if (!window.db) return;
                
                console.log('Syncing to Firebase...');
                console.log('Current local data - Clients:', clients.length, 'Prospects:', prospects.length, 'Projects:', projects.length, 'Invoices:', invoices.length);
                
                // Clear all Firebase data first to prevent duplicates
                await clearFirebaseData();
                
                // Minimal delay after clearing
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Sync clients
                await syncCollectionToFirebase('clients', clients);
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Sync prospects
                await syncCollectionToFirebase('prospects', prospects);
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Sync projects
                await syncCollectionToFirebase('projects', projects);
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Sync invoices
                await syncCollectionToFirebase('invoices', invoices);
                
                console.log('Firebase sync completed');
            } catch (error) {
                console.log('Firebase sync failed (non-critical):', error.message);
            }
        }

        // Sync a collection to Firebase with optimized throttling
        async function syncCollectionToFirebase(collectionName, data) {
            try {
                if (!window.db || !data || data.length === 0) return;
                
                console.log(`Syncing ${collectionName} to Firebase (${data.length} items)`);
                
                // Process items in larger batches for faster sync
                const batchSize = 10;
                for (let i = 0; i < data.length; i += batchSize) {
                    const batch = data.slice(i, i + batchSize);
                    
                    // Process batch with minimal delays
                    for (const item of batch) {
                        if (item.id) {
                            try {
                                // Use the original ID as the document ID
                                const docId = item.id.toString();
                                const docRef = doc(window.db, collectionName, docId);
                                
                                // Remove firebaseId from the data before saving to avoid storing it
                                const { firebaseId, ...itemData } = item;
                                await setDoc(docRef, itemData);
                                
                                // Minimal delay between writes
                                await new Promise(resolve => setTimeout(resolve, 50));
                            } catch (error) {
                                console.log(`Failed to sync item ${item.id} in ${collectionName}:`, error.message);
                            }
                        }
                    }
                    
                    // Shorter delay between batches
                    if (i + batchSize < data.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                console.log(`Successfully synced ${data.length} ${collectionName} to Firebase`);
            } catch (error) {
                console.log(`Firebase sync failed for ${collectionName}:`, error.message);
            }
        }

        // Optional: Load from Firebase (fallback)
        async function loadFromFirebase() {
            try {
                if (!window.db) return false;
                
                console.log('Loading from Firebase...');
                
                // Load clients
                const clientsSnapshot = await getDocs(collection(window.db, 'clients'));
                const firebaseClients = clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load prospects
                const prospectsSnapshot = await getDocs(collection(window.db, 'prospects'));
                const firebaseProspects = prospectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load projects
                const projectsSnapshot = await getDocs(collection(window.db, 'projects'));
                const firebaseProjects = projectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load invoices
                const invoicesSnapshot = await getDocs(collection(window.db, 'invoices'));
                const firebaseInvoices = invoicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Only use Firebase data if localStorage is empty
                if (clients.length === 0 && firebaseClients.length > 0) {
                    clients = firebaseClients;
                    prospects = firebaseProspects;
                    projects = firebaseProjects;
                    invoices = firebaseInvoices;
                    console.log('Loaded data from Firebase');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.log('Firebase load failed (non-critical):', error.message);
                return false;
            }
        }


        // Force reset data to defaults
        function resetDataToDefaults() {
            console.log('Resetting data to defaults');
            // Clear localStorage
            localStorage.removeItem('clients');
            localStorage.removeItem('prospects');
            localStorage.removeItem('projects');
            
            // Reload the page to get fresh default data
            location.reload();
        }

        // Force reset data function for manual use
        function forceResetData() {
            console.log('Force resetting data');
            localStorage.clear();
            
            // Clear all data arrays
            clients = [];
            prospects = [];
            projects = [];
            
            // Save empty data
            saveData();
            
            showNotification('All data has been force reset!', 'success');
            location.reload();
        }

        // Ensure data is properly initialized
        async function ensureDataInitialized() {
            // Check if clients data exists in localStorage, if not, start with empty arrays
            if (!localStorage.getItem('clients')) {
                console.log('No clients data in localStorage, checking Firebase...');
                
                // Try to load from Firebase first
                const loadedFromFirebase = await loadFromFirebase();
                
                if (!loadedFromFirebase) {
                    console.log('No Firebase data found, starting with sample data');
                    // Initialize with sample data
                saveData();
                }
            } else {
                console.log('Loading clients from localStorage');
                // Reload data from localStorage to ensure we have the latest
                clients = JSON.parse(localStorage.getItem('clients')) || [];
                prospects = JSON.parse(localStorage.getItem('prospects')) || [];
                projects = JSON.parse(localStorage.getItem('projects')) || [];
                invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            }
            
            // Ensure arrays are properly initialized
            if (!clients || !Array.isArray(clients)) {
                console.log('Clients array is invalid, resetting to empty array');
                clients = [];
            }
            if (!prospects || !Array.isArray(prospects)) {
                prospects = [];
            }
            if (!projects || !Array.isArray(projects)) {
                projects = [];
            }
            if (!invoices || !Array.isArray(invoices)) {
                invoices = [];
            }
            
            console.log('Data initialized - Clients:', clients.length, 'Prospects:', prospects.length, 'Projects:', projects.length, 'Invoices:', invoices.length);
        }

        // Debug function to check data
        function debugData() {
            console.log('=== DEBUG DATA ===');
            console.log('Clients from localStorage:', JSON.parse(localStorage.getItem('clients') || '[]'));
            console.log('Current clients array:', clients);
            console.log('Contract clients:', clients.filter(c => c.type === 'Contract'));
            console.log('All client types:', clients.map(c => ({ name: c.name, type: c.type, id: c.id })));
            console.log('==================');
        }

        // Test navigation function
        function testNavigation(menuText) {
            console.log('Testing navigation to:', menuText);
            handleMenuNavigation(menuText);
        }

        // Simple test function
        function testClick() {
            console.log('Test click function called');
            const menuItem = document.querySelector('.menu-item');
            if (menuItem) {
                console.log('Menu item found:', menuItem);
                menuItem.click();
            } else {
                console.log('No menu item found');
            }
        }

        // Manual sync functions
        function enableFirebaseSync() {
            autoSyncEnabled = true;
            console.log('Firebase auto-sync enabled');
            updateAutoSyncStatus();
            if (window.db) {
                syncToFirebase();
            }
        }

        function disableFirebaseSync() {
            autoSyncEnabled = false;
            console.log('Firebase auto-sync disabled - using localStorage only');
            updateAutoSyncStatus();
        }

        // Restore data from Firebase (overwrites localStorage)
        async function restoreFromFirebase() {
            try {
                if (!window.db) {
                    console.log('Firebase not available');
                    return false;
                }

                console.log('Restoring data from Firebase...');
                
                // Clear all local data first
                console.log('Clearing local data...');
                clients = [];
                prospects = [];
                projects = [];
                invoices = [];
                
                // Clear localStorage
                localStorage.removeItem('clients');
                localStorage.removeItem('prospects');
                localStorage.removeItem('projects');
                localStorage.removeItem('invoices');
                
                // Load from Firebase
                const clientsSnapshot = await getDocs(collection(window.db, 'clients'));
                const firebaseClients = clientsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Use Firebase document ID as the primary ID, but keep original ID if it exists
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                const prospectsSnapshot = await getDocs(collection(window.db, 'prospects'));
                const firebaseProspects = prospectsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                const projectsSnapshot = await getDocs(collection(window.db, 'projects'));
                const firebaseProjects = projectsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                const invoicesSnapshot = await getDocs(collection(window.db, 'invoices'));
                const firebaseInvoices = invoicesSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                // Update local arrays with Firebase data
                clients = firebaseClients;
                prospects = firebaseProspects;
                projects = firebaseProjects;
                invoices = firebaseInvoices;
                
                console.log('Firebase data loaded - Clients:', clients.length, 'Prospects:', prospects.length, 'Projects:', projects.length, 'Invoices:', invoices.length);
                
                // Save to localStorage
                saveData();
                
                // Update UI
                updateStats();
                showDashboard();
                
                console.log('Data restored from Firebase successfully!');
                showNotification('Data restored from Firebase!', 'success');
                return true;
            } catch (error) {
                console.error('Error restoring from Firebase:', error);
                showNotification('Error restoring from Firebase', 'error');
                return false;
            }
        }

        // Sync from Firebase (merges with existing data)
        async function syncFromFirebase() {
            try {
                if (!window.db) {
                    console.log('Firebase not available');
                    return false;
                }

                console.log('Syncing from Firebase...');
                
                // Load from Firebase
                const clientsSnapshot = await getDocs(collection(window.db, 'clients'));
                const firebaseClients = clientsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                const prospectsSnapshot = await getDocs(collection(window.db, 'prospects'));
                const firebaseProspects = prospectsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                const projectsSnapshot = await getDocs(collection(window.db, 'projects'));
                const firebaseProjects = projectsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                const invoicesSnapshot = await getDocs(collection(window.db, 'invoices'));
                const firebaseInvoices = invoicesSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const originalId = data.id || parseInt(doc.id) || Date.now() + Math.random();
                    return { ...data, id: originalId, firebaseId: doc.id };
                });
                
                // Merge with existing data (Firebase takes priority for conflicts)
                // For sync, we replace the arrays completely to avoid duplicates
                clients = firebaseClients;
                prospects = firebaseProspects;
                projects = firebaseProjects;
                invoices = firebaseInvoices;
                
                console.log('Firebase data synced - Clients:', clients.length, 'Prospects:', prospects.length, 'Projects:', projects.length, 'Invoices:', invoices.length);
                
                // Save to localStorage
                saveData();
                
                // Update UI
                updateStats();
                
                console.log('Data synced from Firebase successfully!');
                showNotification('Data synced from Firebase!', 'success');
                return true;
            } catch (error) {
                console.error('Error syncing from Firebase:', error);
                showNotification('Error syncing from Firebase', 'error');
                return false;
            }
        }

        // Clear all Firebase data with optimized throttling
        async function clearFirebaseData() {
            try {
                if (!window.db) return;
                
                console.log('Clearing all Firebase data...');
                
                const collections = ['clients', 'prospects', 'projects', 'invoices'];
                
                for (const collectionName of collections) {
                    const snapshot = await getDocs(collection(window.db, collectionName));
                    console.log(`Clearing ${collectionName}: ${snapshot.docs.length} documents`);
                    
                    // Process deletions in larger batches for faster clearing
                    const batchSize = 15;
                    for (let i = 0; i < snapshot.docs.length; i += batchSize) {
                        const batch = snapshot.docs.slice(i, i + batchSize);
                        
                        // Process batch with minimal delays
                        for (const docSnapshot of batch) {
                            try {
                                await deleteDoc(docSnapshot.ref);
                                // Minimal delay between deletions
                                await new Promise(resolve => setTimeout(resolve, 30));
                            } catch (error) {
                                console.log(`Failed to delete document ${docSnapshot.id}:`, error.message);
                            }
                        }
                        
                        // Shorter delay between batches
                        if (i + batchSize < snapshot.docs.length) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                }
                
                console.log('All Firebase data cleared');
            } catch (error) {
                console.error('Error clearing Firebase data:', error);
            }
        }

        // Check Firebase connection status
        function checkFirebaseStatus() {
            if (window.db) {
                console.log(' Firebase is connected and ready');
                return true;
            } else {
                console.log(' Firebase is not connected');
                return false;
            }
        }

        // UI functions for Settings page
        function checkFirebaseStatusUI() {
            const statusDiv = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('statusText');
            
            if (window.db) {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.borderColor = '#c3e6cb';
                statusText.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Firebase is connected and ready';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.borderColor = '#f5c6cb';
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Firebase is not connected';
            }
        }

        function updateAutoSyncStatus() {
            const autoSyncDiv = document.getElementById('autoSyncStatus');
            const autoSyncText = document.getElementById('autoSyncText');
            
            if (autoSyncDiv && autoSyncText) {
                if (autoSyncEnabled) {
                    autoSyncDiv.style.background = '#d4edda';
                    autoSyncDiv.style.borderColor = '#c3e6cb';
                    autoSyncText.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Auto-sync is enabled';
                } else {
                    autoSyncDiv.style.background = '#f8d7da';
                    autoSyncDiv.style.borderColor = '#f5c6cb';
                    autoSyncText.innerHTML = '<i class="fas fa-pause-circle" style="color: #dc3545;"></i> Auto-sync is disabled';
                }
            } else {
                console.log('Auto-sync elements not found:', { autoSyncDiv, autoSyncText });
            }
        }

        function testSettingsPage() {
            console.log('=== SETTINGS PAGE TEST ===');
            console.log('Auto-sync enabled:', autoSyncEnabled);
            console.log('Firebase available:', !!window.db);
            
            const autoSyncDiv = document.getElementById('autoSyncStatus');
            const autoSyncText = document.getElementById('autoSyncText');
            const firebaseStatus = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('statusText');
            
            console.log('Elements found:');
            console.log('- autoSyncDiv:', autoSyncDiv);
            console.log('- autoSyncText:', autoSyncText);
            console.log('- firebaseStatus:', firebaseStatus);
            console.log('- statusText:', statusText);
            
            if (autoSyncDiv) {
                console.log('Auto-sync div content:', autoSyncDiv.innerHTML);
            }
            
            showNotification('Settings page test completed - check console', 'info');
        }

        async function syncToFirebaseUI() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            button.disabled = true;
            
            try {
                await syncToFirebase();
                showNotification('Data synced to Firebase successfully!', 'success');
            } catch (error) {
                showNotification('Error syncing to Firebase: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function restoreFromFirebaseUI() {
            if (!confirm('This will overwrite your current data with data from Firebase. Are you sure?')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
            button.disabled = true;
            
            try {
                await restoreFromFirebase();
                showNotification('Data restored from Firebase successfully!', 'success');
            } catch (error) {
                showNotification('Error restoring from Firebase: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function syncFromFirebaseUI() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            button.disabled = true;
            
            try {
                await syncFromFirebase();
                showNotification('Data synced from Firebase successfully!', 'success');
            } catch (error) {
                showNotification('Error syncing from Firebase: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Debug function to check Firebase data
        async function debugFirebaseData() {
            try {
                if (!window.db) {
                    console.log('Firebase not available');
                    return;
                }
                
                console.log('=== FIREBASE DEBUG DATA ===');
                
                const collections = ['clients', 'prospects', 'projects', 'invoices'];
                
                for (const collectionName of collections) {
                    const snapshot = await getDocs(collection(window.db, collectionName));
                    console.log(`${collectionName.toUpperCase()}: ${snapshot.docs.length} documents`);
                    
                    snapshot.docs.forEach((doc, index) => {
                        console.log(`  ${index + 1}. ID: ${doc.id}, Data:`, doc.data());
                    });
                }
                
                console.log('=== LOCAL DATA ===');
                console.log('Clients:', clients.length, clients);
                console.log('Prospects:', prospects.length, prospects);
                console.log('Projects:', projects.length, projects);
                console.log('Invoices:', invoices.length, invoices);
                console.log('========================');
            } catch (error) {
                console.error('Error debugging Firebase data:', error);
            }
        }

        // Make functions available globally
        window.testNavigation = testNavigation;
        window.testClick = testClick;
        window.enableFirebaseSync = enableFirebaseSync;
        window.disableFirebaseSync = disableFirebaseSync;
        window.syncToFirebase = syncToFirebase;
        window.restoreFromFirebase = restoreFromFirebase;
        window.syncFromFirebase = syncFromFirebase;
        window.checkFirebaseStatus = checkFirebaseStatus;
        window.checkFirebaseStatusUI = checkFirebaseStatusUI;
        window.syncToFirebaseUI = syncToFirebaseUI;
        window.restoreFromFirebaseUI = restoreFromFirebaseUI;
        window.syncFromFirebaseUI = syncFromFirebaseUI;
        window.clearFirebaseData = clearFirebaseData;
        window.debugFirebaseData = debugFirebaseData;
        window.testSettingsPage = testSettingsPage;

        // Toggle contract options visibility
        function toggleContractOptions() {
            const contractRadio = document.getElementById('contract');
            const contractOptions = document.getElementById('contractOptions');
            
            if (contractRadio && contractOptions) {
                if (contractRadio.checked) {
                    contractOptions.style.display = 'block';
                } else {
                    contractOptions.style.display = 'none';
                }
            }
        }

        // Update client status based on payment and engagement type
        function updateClientStatus() {
            const paymentStatus = document.getElementById('paymentStatus');
            const engagementType = document.querySelector('input[name="engagementType"]:checked');
            const clientStatus = document.getElementById('clientStatus');
            
            if (paymentStatus && engagementType && clientStatus) {
                // If fully paid and one-time, automatically set to closed
                if (paymentStatus.value === 'fully-paid' && engagementType.value === 'onetime') {
                    clientStatus.value = 'Closed';
                } else if (paymentStatus.value === 'deposit' && (clientStatus.value === 'Closed' || clientStatus.value === 'Paused')) {
                    // If changed from fully paid to deposit, set back to active
                    clientStatus.value = 'Active';
                }
            }
        }

        // Toggle payment tracking visibility
        function togglePaymentTracking() {
            const contractDuration = document.getElementById('contractDuration');
            const paymentTracking = document.getElementById('paymentTracking');
            
            if (contractDuration && paymentTracking) {
                if (contractDuration.value === 'monthly') {
                    paymentTracking.style.display = 'block';
                    updatePaymentTrackingDisplay();
                } else {
                    paymentTracking.style.display = 'none';
                }
            }
        }

        // Update payment tracking display
        function updatePaymentTrackingDisplay() {
            const totalPaymentsCount = document.getElementById('totalPaymentsCount');
            const totalAmountPaid = document.getElementById('totalAmountPaid');
            
            if (totalPaymentsCount && totalAmountPaid) {
                // Get current client data if editing
                const currentClient = getCurrentEditingClient();
                if (currentClient && currentClient.monthlyPayments) {
                    const totalPayments = currentClient.monthlyPayments.length;
                    const totalAmount = currentClient.monthlyPayments.reduce((sum, payment) => sum + payment.amount, 0);
                    
                    totalPaymentsCount.textContent = totalPayments;
                    totalAmountPaid.textContent = `KSh ${totalAmount.toLocaleString()}`;
                } else {
                    totalPaymentsCount.textContent = '0';
                    totalAmountPaid.textContent = 'KSh 0';
                }
            }
        }

        // Get current client being edited
        function getCurrentEditingClient() {
            // This would be set when editing a client
            return window.currentEditingClient || null;
        }

        // Add manual payment
        function addManualPayment() {
            const currentClient = getCurrentEditingClient();
            if (!currentClient) {
                alert('Please save the client first before adding payments');
                return;
            }

            const manualAmount = parseFloat(document.getElementById('manualPaymentAmount').value) || 0;
            if (manualAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }

            const newPayment = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                amount: manualAmount
            };

            if (!currentClient.monthlyPayments) {
                currentClient.monthlyPayments = [];
            }
            
            currentClient.monthlyPayments.push(newPayment);
            currentClient.paidAmount = currentClient.monthlyPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            // Clear input
            document.getElementById('manualPaymentAmount').value = '';
            
            updatePaymentTrackingDisplay();
            updatePaymentHistory();
            showNotification(`Payment of KSh ${manualAmount.toLocaleString()} added successfully!`, 'success');
        }

        // Add full payment
        function addFullPayment() {
            const currentClient = getCurrentEditingClient();
            if (!currentClient) {
                alert('Please save the client first before adding payments');
                return;
            }

            const projectValue = parseFloat(document.getElementById('projectValue').value) || 0;
            if (projectValue <= 0) {
                alert('Please enter a valid project value first');
                return;
            }

            const newPayment = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                amount: projectValue
            };

            if (!currentClient.monthlyPayments) {
                currentClient.monthlyPayments = [];
            }
            
            currentClient.monthlyPayments.push(newPayment);
            currentClient.paidAmount = currentClient.monthlyPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            updatePaymentTrackingDisplay();
            updatePaymentHistory();
            showNotification(`Full payment of KSh ${projectValue.toLocaleString()} added successfully!`, 'success');
        }

        // Remove payment
        function removePayment(paymentId) {
            const currentClient = getCurrentEditingClient();
            if (!currentClient || !currentClient.monthlyPayments) return;

            if (confirm('Are you sure you want to remove this payment?')) {
                currentClient.monthlyPayments = currentClient.monthlyPayments.filter(p => p.id !== paymentId);
                currentClient.paidAmount = currentClient.monthlyPayments.reduce((sum, payment) => sum + payment.amount, 0);
                
                updatePaymentTrackingDisplay();
                updatePaymentHistory();
                showNotification('Payment removed successfully!', 'success');
            }
        }

        // Update payment history display
        function updatePaymentHistory() {
            const currentClient = getCurrentEditingClient();
            const paymentList = document.getElementById('paymentList');
            
            if (!paymentList) return;

            if (!currentClient || !currentClient.monthlyPayments || currentClient.monthlyPayments.length === 0) {
                paymentList.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">No payments recorded</div>';
                return;
            }

            paymentList.innerHTML = currentClient.monthlyPayments.map(payment => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; margin-bottom: 5px; border-radius: 4px; border: 1px solid #e9ecef;">
                    <div>
                        <span style="font-weight: bold;">KSh ${payment.amount.toLocaleString()}</span>
                        <br><small style="color: #666;">${new Date(payment.date).toLocaleDateString()}</small>
                    </div>
                    <button type="button" onclick="removePayment(${payment.id})" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Switch analytics tabs
        function switchAnalyticsTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.analytics-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.analytics-tab-content').length > 0 ? 
                document.querySelectorAll('.tabs .tab') : [];
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`analytics-${tabName}`);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }

            // Add active class to clicked tab
            const clickedTab = event.target;
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Initializing dashboard');
            await ensureDataInitialized();
            initializeSidebar();
            initializeTabs();
            initializeForms();
            initializeSearch();
            updateStats();
            console.log('Dashboard initialization complete');
            
            // Test navigation
            console.log('Testing navigation...');
            setTimeout(() => {
                console.log('Sidebar elements:', document.querySelectorAll('.menu-item').length);
                console.log('Main content:', document.querySelector('.main-content'));
            }, 1000);
        });

        // Sidebar navigation - using event delegation for better reliability
        function initializeSidebar() {
            // Use event delegation on the sidebar to handle clicks
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                // Remove existing event listeners
                sidebar.removeEventListener('click', handleSidebarClick);
                // Add new event listener with event delegation
                sidebar.addEventListener('click', handleSidebarClick);
            }
        }

        function handleSidebarClick(e) {
            // Check if clicked element is a menu item or inside a menu item
            const menuItem = e.target.closest('.menu-item');
            if (!menuItem) return;

            e.preventDefault();
            
            // Remove active class from all menu items
            const allMenuItems = document.querySelectorAll('.menu-item');
            allMenuItems.forEach(mi => mi.classList.remove('active'));
            
            // Add active class to clicked item
            menuItem.classList.add('active');
            
            // Get menu text
            const menuText = menuItem.querySelector('span').textContent;
            
            // Close sidebar on mobile after selection
            handleMobileMenuClick();
            
            // Show/hide relevant sections based on menu selection
            handleMenuNavigation(menuText);
        }

        function handleMenuNavigation(menuText) {
            // Ensure data consistency before switching pages
            ensureDataConsistency();
            
            // Update page title
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                pageTitle.textContent = menuText;
            }
            
            switch(menuText) {
                case 'Dashboard':
                    showDashboard();
                    break;
                case 'Clients':
                    showClients();
                    break;
                case 'Projects':
                    showProjectsPage();
                    break;
                case 'Analytics':
                    showAnalytics();
                    break;
                case 'Outreach':
                    showOutreach();
                    break;
                case 'Invoices':
                    showInvoices();
                    break;
                case 'Settings':
                    showSettings();
                    break;
            }
        }

        function showDashboard() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="d-flex align-center gap-10">
                        <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                            <input type="text" class="form-control" placeholder="Search...">
                        </div>
                        <button class="btn btn-primary"><i class="fas fa-plus"></i> New Client</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(108, 99, 255, 0.1); color: var(--primary);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalRevenue">KSh ${clients.reduce((sum, client) => sum + (client.paidAmount || 0), 0).toLocaleString()}</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(78, 205, 196, 0.1); color: var(--secondary);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="activeClients">${clients.filter(c => c.status === 'Active').length}</h3>
                            <p>Active Clients</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning);">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="ongoingProjects">${projects.filter(p => p.status === 'Active' || p.status === 'In Progress').length}</h3>
                            <p>Ongoing Projects</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(220, 53, 69, 0.1); color: var(--danger);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pendingProposals">${prospects.filter(p => p.status === 'Awaiting Response').length}</h3>
                            <p>Pending Proposals</p>
                        </div>
                    </div>
                </div>


                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active">Client Management</div>
                    <div class="tab">Outreach Tracking</div>
                </div>

                <!-- Client Management -->
                <div class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Add New Client</h2>
                        </div>
                        <form>
                            <div class="form-group">
                                <label for="clientName">Client Name</label>
                                <input type="text" class="form-control" id="clientName" placeholder="Enter client name">
                            </div>
                            <div class="form-group">
                                <label for="clientEmail">Email Address</label>
                                <input type="email" class="form-control" id="clientEmail" placeholder="Enter email">
                            </div>
                            <div class="form-group">
                                <label for="clientPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label for="serviceType">Service Type</label>
                                <select class="form-control" id="serviceType">
                                    <option value="">Select service type</option>
                                    <option value="logo">Logo Design</option>
                                    <option value="branding">Branding Package</option>
                                    <option value="web">Web Design</option>
                                    <option value="social">Social Media Graphics</option>
                                    <option value="print">Print Design</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Engagement Type</label>
                                <div style="display: flex; gap: 20px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" id="contract" name="engagementType" value="contract" onchange="toggleContractOptions()">
                                        <span>Contract</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" id="onetime" name="engagementType" value="onetime" onchange="toggleContractOptions()">
                                        <span>One-Time</span>
                                    </label>
                                </div>
                                <div id="contractOptions" style="display: none; margin-top: 15px;">
                                    <label>Contract Duration</label>
                                    <select class="form-control" id="contractDuration" onchange="togglePaymentTracking()">
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <div id="paymentTracking" style="display: none; margin-top: 15px;">
                                        <label>Payment Tracking</label>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span><strong>Total Payments Made:</strong></span>
                                                <span id="totalPaymentsCount" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">0</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <span><strong>Total Amount Paid:</strong></span>
                                                <span id="totalAmountPaid" style="color: var(--success); font-weight: bold;">KSh 0</span>
                                            </div>
                                            
                                            <!-- Payment Input Section -->
                                            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Add Payment</label>
                                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                                    <input type="number" id="manualPaymentAmount" placeholder="Enter amount" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                    <button type="button" class="btn" style="background: var(--success); color: white; padding: 8px 15px;" onclick="addManualPayment()">
                                                        <i class="fas fa-plus"></i> Add
                                                    </button>
                                                </div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button type="button" class="btn" style="background: var(--primary); color: white; flex: 1;" onclick="addFullPayment()">
                                                        <i class="fas fa-check"></i> Add Full Project Amount
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Payment History -->
                                            <div id="paymentHistory" style="max-height: 150px; overflow-y: auto;">
                                                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Payment History</label>
                                                <div id="paymentList" style="font-size: 0.9rem;">
                                                    <div style="text-align: center; color: #666; padding: 10px;">No payments recorded</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="projectValue">Project Value</label>
                                <input type="number" class="form-control" id="projectValue" placeholder="Enter amount">
                            </div>
                            <div class="form-group">
                                <label for="paymentStatus">Payment Status</label>
                                <select class="form-control" id="paymentStatus" onchange="updateClientStatus()">
                                    <option value="pending">Pending</option>
                                    <option value="deposit">Deposit (50%)</option>
                                    <option value="fully-paid">Fully Paid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="clientStatus">Client Status</label>
                                <select class="form-control" id="clientStatus">
                                    <option value="Active">Active</option>
                                    <option value="Paused">Paused</option>
                                    <option value="Closed">Closed</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Client</button>
                        </form>
                    </div>

                </div>


                <!-- Outreach Tracking -->
                <div class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Add New Prospect</h2>
                        </div>
                        <form>
                            <div class="form-group">
                                <label for="prospectName">Prospect Name</label>
                                <input type="text" class="form-control" id="prospectName" placeholder="Enter prospect name">
                            </div>
                            <div class="form-group">
                                <label for="prospectCompany">Company</label>
                                <input type="text" class="form-control" id="prospectCompany" placeholder="Enter company name">
                            </div>
                            <div class="form-group">
                                <label for="prospectEmail">Email Address</label>
                                <input type="email" class="form-control" id="prospectEmail" placeholder="Enter email">
                            </div>
                            <div class="form-group">
                                <label for="prospectPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="prospectPhone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label for="proposedService">Proposed Service</label>
                                <select class="form-control" id="proposedService">
                                    <option value="">Select service type</option>
                                    <option value="logo">Logo Design</option>
                                    <option value="branding">Branding Package</option>
                                    <option value="web">Web Design</option>
                                    <option value="social">Social Media Graphics</option>
                                    <option value="print">Print Design</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Prospect</button>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Prospect Pipeline</h2>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Prospect</th>
                                        <th>Company</th>
                                        <th>Contact</th>
                                        <th>Proposed Service</th>
                                        <th>Proposal Sent</th>
                                        <th>Response</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${renderProspectTable()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Re-initialize dashboard functionality
            initializeTabs();
            initializeForms();
            initializeSearch();
            
            // Add search functionality for dashboard
            const searchInput = document.querySelector('input[placeholder="Search..."]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const clientRows = document.querySelectorAll('tbody tr');
                    clientRows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }

        function showClients() {
            const stats = calculateClientStats();
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Clients</h1>
                    <div class="d-flex align-center gap-10">
                        <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                            <input type="text" class="form-control" placeholder="Search clients...">
                        </div>
                        <button class="btn btn-primary" onclick="showAddClientForm()"><i class="fas fa-plus"></i> New Client</button>
                    </div>
                </div>

                <!-- Client Analytics with Tabs -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">Client Analytics</h3>
                    </div>
                    <div class="card-body" style="padding: 15px;">
                        <!-- Analytics Tabs -->
                        <div class="tabs" style="margin-bottom: 15px;">
                            <div class="tab active" onclick="switchAnalyticsTab('overview')">Overview</div>
                            <div class="tab" onclick="switchAnalyticsTab('status')">Status</div>
                            <div class="tab" onclick="switchAnalyticsTab('payments')">Payments</div>
                            <div class="tab" onclick="switchAnalyticsTab('contracts')">Contracts</div>
                        </div>
                        
                        <!-- Overview Tab -->
                        <div id="analytics-overview" class="analytics-tab-content">
                            <!-- Horizontal Overview Tabs -->
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px; text-align: center; padding: 15px; background: #6C63FF; color: white; border-radius: 8px;">
                                    <h3 style="margin: 0; font-size: 1.8rem;">${stats.totalClients}</h3>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Total Clients</p>
                                </div>
                                <div style="flex: 1; min-width: 200px; text-align: center; padding: 15px; background: #28A745; color: white; border-radius: 8px;">
                                    <h3 style="margin: 0; font-size: 1.8rem;">KSh ${stats.totalRevenue.toLocaleString()}</h3>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Total Revenue</p>
                                </div>
                            </div>
                            
                            <!-- Additional Metrics Row -->
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 150px; text-align: center; padding: 12px; background: #4ECDC4; color: white; border-radius: 8px;">
                                    <h4 style="margin: 0; font-size: 1.5rem;">${stats.activeClients}</h4>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.85rem;">Active</p>
                                </div>
                                <div style="flex: 1; min-width: 150px; text-align: center; padding: 12px; background: #FFC107; color: #333; border-radius: 8px;">
                                    <h4 style="margin: 0; font-size: 1.5rem;">${stats.pausedClients}</h4>
                                    <p style="margin: 5px 0 0 0; opacity: 0.8; font-size: 0.85rem;">Paused</p>
                                </div>
                                <div style="flex: 1; min-width: 150px; text-align: center; padding: 12px; background: #6C757D; color: white; border-radius: 8px;">
                                    <h4 style="margin: 0; font-size: 1.5rem;">${stats.closedClients}</h4>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.85rem;">Closed</p>
                                </div>
                                <div style="flex: 1; min-width: 150px; text-align: center; padding: 12px; background: #DC3545; color: white; border-radius: 8px;">
                                    <h4 style="margin: 0; font-size: 1.5rem;">KSh ${stats.pendingRevenue.toLocaleString()}</h4>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.85rem;">Pending</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Tab -->
                        <div id="analytics-status" class="analytics-tab-content" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                        <h4 style="margin: 0 0 10px 0; color: #333;">Client Status</h4>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Active:</span>
                                            <span style="color: var(--success); font-weight: bold;">${stats.activeClients}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Paused:</span>
                                            <span style="color: var(--warning); font-weight: bold;">${stats.pausedClients}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Closed:</span>
                                            <span style="color: var(--gray); font-weight: bold;">${stats.closedClients}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                        <h4 style="margin: 0 0 10px 0; color: #333;">Status Distribution</h4>
                                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 120px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${stats.activeClients}</div>
                                                <div style="font-size: 0.9rem; color: #666;">Active</div>
                                            </div>
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 120px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${stats.pausedClients}</div>
                                                <div style="font-size: 0.9rem; color: #666;">Paused</div>
                                            </div>
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 120px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--gray);">${stats.closedClients}</div>
                                                <div style="font-size: 0.9rem; color: #666;">Closed</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payments Tab -->
                        <div id="analytics-payments" class="analytics-tab-content" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                        <h4 style="margin: 0 0 10px 0; color: #333;">Payment Status</h4>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Fully Paid:</span>
                                            <span style="color: var(--success); font-weight: bold;">${stats.paymentStatus.fullyPaid}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Deposit Only:</span>
                                            <span style="color: var(--warning); font-weight: bold;">${stats.paymentStatus.deposit}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Pending:</span>
                                            <span style="color: var(--warning); font-weight: bold;">${stats.paymentStatus.pending}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Pending Revenue:</span>
                                            <span style="color: var(--primary); font-weight: bold;">KSh ${stats.pendingRevenue.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                        <h4 style="margin: 0 0 10px 0; color: #333;">Revenue Summary</h4>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Total Revenue:</span>
                                            <span style="color: var(--success); font-weight: bold;">KSh ${stats.totalRevenue.toLocaleString()}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Total Project Value:</span>
                                            <span style="color: var(--info); font-weight: bold;">KSh ${stats.totalProjectValue.toLocaleString()}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Completion Rate:</span>
                                            <span style="color: var(--primary); font-weight: bold;">${stats.totalProjectValue > 0 ? Math.round((stats.totalRevenue / stats.totalProjectValue) * 100) : 0}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contracts Tab -->
                        <div id="analytics-contracts" class="analytics-tab-content" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                        <h4 style="margin: 0 0 10px 0; color: #333;">Contract Types</h4>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Weekly:</span>
                                            <span style="color: var(--primary); font-weight: bold;">${stats.contractTypes.weekly}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Monthly:</span>
                                            <span style="color: var(--success); font-weight: bold;">${stats.contractTypes.monthly}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Quarterly:</span>
                                            <span style="color: var(--warning); font-weight: bold;">${stats.contractTypes.quarterly}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Yearly:</span>
                                            <span style="color: var(--danger); font-weight: bold;">${stats.contractTypes.yearly}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                        <h4 style="margin: 0 0 10px 0; color: #333;">Contract Distribution</h4>
                                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${stats.contractTypes.weekly}</div>
                                                <div style="font-size: 0.8rem; color: #666;">Weekly</div>
                                            </div>
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${stats.contractTypes.monthly}</div>
                                                <div style="font-size: 0.8rem; color: #666;">Monthly</div>
                                            </div>
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${stats.contractTypes.quarterly}</div>
                                                <div style="font-size: 0.8rem; color: #666;">Quarterly</div>
                                            </div>
                                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; flex: 1; min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);">${stats.contractTypes.yearly}</div>
                                                <div style="font-size: 0.8rem; color: #666;">Yearly</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Current Clients</h2>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Service</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Payment Status</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderClientTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Add search functionality for clients
            const searchInput = document.querySelector('input[placeholder="Search clients..."]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const clientRows = document.querySelectorAll('tbody tr');
                    clientRows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }

        function showAddClientForm() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Add New Client</h1>
                    <button class="btn" onclick="showClients()" style="background: var(--gray); color: white;"><i class="fas fa-arrow-left"></i> Back to Clients</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Client Details</h2>
                    </div>
                    <form id="clientForm">
                        <div class="form-group">
                            <label for="clientName">Client Name</label>
                            <input type="text" class="form-control" id="clientName" placeholder="Enter client name">
                        </div>
                        <div class="form-group">
                            <label for="clientEmail">Email Address</label>
                            <input type="email" class="form-control" id="clientEmail" placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="clientPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label for="serviceType">Service Type</label>
                            <select class="form-control" id="serviceType">
                                <option value="">Select service type</option>
                                <option value="logo">Logo Design</option>
                                <option value="branding">Branding Package</option>
                                <option value="web">Web Design</option>
                                <option value="social">Social Media Graphics</option>
                                <option value="print">Print Design</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Engagement Type</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" id="contract" name="engagementType" value="contract" onchange="toggleContractOptions()">
                                    <span>Contract</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" id="onetime" name="engagementType" value="onetime" onchange="toggleContractOptions()">
                                    <span>One-Time</span>
                                </label>
                            </div>
                            <div id="contractOptions" style="display: none; margin-top: 15px;">
                                <label>Contract Duration</label>
                                <select class="form-control" id="contractDuration" onchange="togglePaymentTracking()">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                                <div id="paymentTracking" style="display: none; margin-top: 15px;">
                                    <label>Payment Tracking</label>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <span><strong>Total Payments Made:</strong></span>
                                            <span id="totalPaymentsCount" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">0</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <span><strong>Total Amount Paid:</strong></span>
                                            <span id="totalAmountPaid" style="color: var(--success); font-weight: bold;">KSh 0</span>
                                        </div>
                                        
                                        <!-- Payment Input Section -->
                                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">Add Payment</label>
                                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                                <input type="number" id="manualPaymentAmount" placeholder="Enter amount" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <button type="button" class="btn" style="background: var(--success); color: white; padding: 8px 15px;" onclick="addManualPayment()">
                                                    <i class="fas fa-plus"></i> Add
                                                </button>
                                            </div>
                                            <div style="display: flex; gap: 10px;">
                                                <button type="button" class="btn" style="background: var(--primary); color: white; flex: 1;" onclick="addFullPayment()">
                                                    <i class="fas fa-check"></i> Add Full Project Amount
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Payment History -->
                                        <div id="paymentHistory" style="max-height: 150px; overflow-y: auto;">
                                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">Payment History</label>
                                            <div id="paymentList" style="font-size: 0.9rem;">
                                                <div style="text-align: center; color: #666; padding: 10px;">No payments recorded</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="projectValue">Project Value</label>
                            <input type="number" class="form-control" id="projectValue" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label for="paymentStatus">Payment Status</label>
                            <select class="form-control" id="paymentStatus" onchange="updateClientStatus()">
                                <option value="pending">Pending</option>
                                <option value="deposit">Deposit (50%)</option>
                                <option value="fully-paid">Fully Paid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="clientStatus">Client Status</label>
                            <select class="form-control" id="clientStatus">
                                <option value="Active">Active</option>
                                <option value="Paused">Paused</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Client</button>
                    </form>
                </div>
            `;

            // Initialize form functionality
            initializeForms();
        }

        function showAnalytics() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Analytics</h1>
                </div>

                <div class="chart-container">
                    <div class="chart-card">
                        <h2 class="card-title mb-20">Revenue by Service Type</h2>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h2 class="card-title mb-20">Monthly Revenue</h2>
                        <canvas id="monthlyRevenueChart"></canvas>
                    </div>
                </div>
                
                <div class="card mt-20">
                    <div class="card-header">
                        <h2 class="card-title">Revenue Summary</h2>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Service Type</th>
                                    <th>Number of Projects</th>
                                    <th>Total Revenue</th>
                                    <th>Average Project Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Logo Design</td>
                                    <td>12</td>
                                    <td>KSh 9,600</td>
                                    <td>KSh 800</td>
                                </tr>
                                <tr>
                                    <td>Branding Package</td>
                                    <td>8</td>
                                    <td>KSh 28,500</td>
                                    <td>KSh 3,562</td>
                                </tr>
                                <tr>
                                    <td>Web Design</td>
                                    <td>5</td>
                                    <td>KSh 31,200</td>
                                    <td>KSh 6,240</td>
                                </tr>
                                <tr>
                                    <td>Social Media Graphics</td>
                                    <td>15</td>
                                    <td>KSh 12,000</td>
                                    <td>KSh 800</td>
                                </tr>
                                <tr>
                                    <td>Print Design</td>
                                    <td>7</td>
                                    <td>KSh 8,400</td>
                                    <td>KSh 1,200</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Render charts
            renderCharts();
        }

        function showOutreach() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Outreach</h1>
                    <div class="d-flex align-center gap-10">
                        <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                            <input type="text" class="form-control" placeholder="Search prospects..." id="prospectSearch">
                        </div>
                        <button class="btn btn-primary" onclick="showAddProspectForm()"><i class="fas fa-plus"></i> New Prospect</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Prospect Pipeline</h2>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Prospect</th>
                                    <th>Company</th>
                                    <th>Contact</th>
                                    <th>Proposed Service</th>
                                    <th>Proposal Sent</th>
                                    <th>Response</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderProspectTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Initialize search functionality
            const searchInput = document.getElementById('prospectSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterProspectTable(searchTerm);
                });
            }
        }

        function showInvoices() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Invoice Generation</h1>
                    <div class="d-flex align-center gap-10">
                        <button class="btn btn-primary" onclick="showCreateInvoiceForm()"><i class="fas fa-plus"></i> Create New Invoice</button>
                    </div>
                </div>

                <!-- Invoice Stats -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(108, 99, 255, 0.1); color: var(--primary);">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalInvoices">0</h3>
                            <p>Total Invoices</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(40, 167, 69, 0.1); color: var(--success);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="paidInvoices">0</h3>
                            <p>Paid Invoices</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pendingInvoices">0</h3>
                            <p>Pending Invoices</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(78, 205, 196, 0.1); color: var(--secondary);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalInvoiceAmount">KSh 0</h3>
                            <p>Total Collected</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Invoices -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Invoices</h2>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Total Collected</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                ${renderInvoicesTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Update invoice stats
            updateInvoiceStats();
        }

        function showCreateInvoiceForm() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Create New Invoice</h1>
                    <button class="btn" onclick="showInvoices()" style="background: var(--gray); color: white;"><i class="fas fa-arrow-left"></i> Back to Invoices</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Invoice Details</h2>
                    </div>
                    <form id="invoiceForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="invoiceClient">Select Client *</label>
                                    <select class="form-control" id="invoiceClient" required onchange="loadClientDetails()">
                                        <option value="">Choose a client...</option>
                                        ${clients.map(client => `<option value="${client.id}">${client.name} - ${client.email}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="invoiceNumber">Invoice Number</label>
                                    <input type="text" class="form-control" id="invoiceNumber" value="INV-${Date.now()}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="invoiceDate">Invoice Date</label>
                                    <input type="date" class="form-control" id="invoiceDate" value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dueDate">Due Date</label>
                                    <input type="date" class="form-control" id="dueDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="invoiceDescription">Description</label>
                            <textarea class="form-control" id="invoiceDescription" rows="3" placeholder="Enter service description or project details" required></textarea>
                        </div>

                        <!-- Invoice Items -->
                        <div class="form-group">
                            <label>Invoice Items</label>
                            <div id="invoiceItems">
                                <div class="invoice-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: end;">
                                    <div style="flex: 2;">
                                        <input type="text" class="form-control" placeholder="Item description" required>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" class="form-control" placeholder="Quantity" value="1" min="1" required>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01" required>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" class="form-control" placeholder="Amount" readonly>
                                    </div>
                                    <div>
                                        <button type="button" class="btn" style="background: var(--danger); color: white;" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn" style="background: var(--success); color: white; margin-top: 10px;" onclick="addInvoiceItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="taxRate">Tax Rate (%)</label>
                                    <input type="number" class="form-control" id="taxRate" value="16" min="0" max="100" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="discount">Discount (KSh)</label>
                                    <input type="number" class="form-control" id="discount" value="0" min="0" step="0.01">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea class="form-control" id="notes" rows="2" placeholder="Additional notes or terms"></textarea>
                        </div>

                        <div class="card" style="background: #f8f9fa; padding: 20px; margin-top: 20px;">
                            <h4>Invoice Summary</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotal">KSh 0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Tax:</span>
                                <span id="invoiceTax">KSh 0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Discount:</span>
                                <span id="invoiceDiscount">KSh 0.00</span>
                            </div>
                            <hr>
                            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold;">
                                <span>Total:</span>
                                <span id="invoiceTotal">KSh 0.00</span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Invoice
                            </button>
                            <button type="button" class="btn" style="background: var(--success); color: white;" onclick="previewInvoice()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button type="button" class="btn" style="background: var(--info); color: white;" onclick="generatePDF()">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Set default due date to 30 days from now
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];

            // Initialize invoice form functionality
            initializeInvoiceForm();
        }

        // Invoice data storage (already declared above)

        // Company details for invoices
        let companyDetails = JSON.parse(localStorage.getItem('companyDetails')) || {
            name: 'NoveyoTech',
            tagline: 'Professional Design Services',
            email: 'info@noveyotech.com',
            phone: '+254 700 000 000',
            website: 'www.noveyotech.com',
            address: 'Nairobi, Kenya',
            paymentTerms: 'Net 30 days',
            logoUrl: 'logo.png'
        };

        // Initialize invoice form
        function initializeInvoiceForm() {
            const form = document.getElementById('invoiceForm');
            if (form) {
                form.addEventListener('submit', handleInvoiceSubmit);
            }

            // Add event listeners for calculations
            const itemsContainer = document.getElementById('invoiceItems');
            if (itemsContainer) {
                itemsContainer.addEventListener('input', calculateInvoiceTotal);
            }

            const taxRate = document.getElementById('taxRate');
            const discount = document.getElementById('discount');
            if (taxRate) taxRate.addEventListener('input', calculateInvoiceTotal);
            if (discount) discount.addEventListener('input', calculateInvoiceTotal);

            // Calculate initial total
            calculateInvoiceTotal();
        }

        // Load client details when client is selected
        function loadClientDetails() {
            const clientSelect = document.getElementById('invoiceClient');
            const selectedClientId = parseInt(clientSelect.value);
            const client = clients.find(c => c.id === selectedClientId);
            
            if (client) {
                // Pre-fill description with client's service
                const descriptionField = document.getElementById('invoiceDescription');
                if (descriptionField && !descriptionField.value) {
                    descriptionField.value = `${client.service} - ${client.name}`;
                }
            }
        }

        // Add invoice item
        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoiceItems');
            const newItem = document.createElement('div');
            newItem.className = 'invoice-item';
            newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: end;';
            
            newItem.innerHTML = `
                <div style="flex: 2;">
                    <input type="text" class="form-control" placeholder="Item description" required>
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-control" placeholder="Quantity" value="1" min="1" required>
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01" required>
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-control" placeholder="Amount" readonly>
                </div>
                <div>
                    <button type="button" class="btn" style="background: var(--danger); color: white;" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            itemsContainer.appendChild(newItem);
            
            // Add event listeners to new item
            const inputs = newItem.querySelectorAll('input');
            inputs.forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('input', calculateInvoiceTotal);
                }
            });
        }

        // Remove invoice item
        function removeInvoiceItem(button) {
            const item = button.closest('.invoice-item');
            if (item) {
                item.remove();
                calculateInvoiceTotal();
            }
        }

        // Calculate invoice total
        function calculateInvoiceTotal() {
            const items = document.querySelectorAll('.invoice-item');
            let subtotal = 0;
            
            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('input[placeholder="Quantity"]').value) || 0;
                const rate = parseFloat(item.querySelector('input[placeholder="Rate"]').value) || 0;
                const amount = quantity * rate;
                
                item.querySelector('input[placeholder="Amount"]').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            
            const tax = (subtotal * taxRate) / 100;
            const total = subtotal + tax - discount;
            
            // Update display
            document.getElementById('invoiceSubtotal').textContent = `KSh ${subtotal.toFixed(2)}`;
            document.getElementById('invoiceTax').textContent = `KSh ${tax.toFixed(2)}`;
            document.getElementById('invoiceDiscount').textContent = `KSh ${discount.toFixed(2)}`;
            document.getElementById('invoiceTotal').textContent = `KSh ${total.toFixed(2)}`;
        }

        // Handle invoice form submission
        function handleInvoiceSubmit(e) {
            e.preventDefault();
            
            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Please select a client');
                return;
            }
            
            // Collect invoice items
            const items = [];
            const itemElements = document.querySelectorAll('.invoice-item');
            itemElements.forEach(item => {
                const description = item.querySelector('input[placeholder="Item description"]').value;
                const quantity = parseFloat(item.querySelector('input[placeholder="Quantity"]').value) || 0;
                const rate = parseFloat(item.querySelector('input[placeholder="Rate"]').value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate > 0) {
                    items.push({ description, quantity, rate, amount });
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one invoice item');
                return;
            }
            
            const invoiceData = {
                id: Date.now(),
                invoiceNumber: document.getElementById('invoiceNumber').value,
                clientId: clientId,
                clientName: client.name,
                clientEmail: client.email,
                clientPhone: client.phone,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                description: document.getElementById('invoiceDescription').value,
                items: items,
                subtotal: parseFloat(document.getElementById('invoiceSubtotal').textContent.replace('KSh ', '')),
                taxRate: parseFloat(document.getElementById('taxRate').value),
                tax: parseFloat(document.getElementById('invoiceTax').textContent.replace('KSh ', '')),
                discount: parseFloat(document.getElementById('discount').value),
                total: parseFloat(document.getElementById('invoiceTotal').textContent.replace('KSh ', '')),
                notes: document.getElementById('notes').value,
                status: 'Pending',
                createdAt: new Date().toISOString()
            };
            
            // Add invoice to storage
            invoices.push(invoiceData);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Show success message and return to invoices
            showNotification('Invoice created successfully!', 'success');
            showInvoices();
        }

        // Calculate total collected based on payment status
        function calculateTotalCollected(invoice) {
            switch(invoice.status) {
                case 'Paid':
                    return invoice.total;
                case 'Pending':
                case 'Overdue':
                case 'Cancelled':
                default:
                    return 0;
            }
        }

        // Update invoice stats
        function updateInvoiceStats() {
            const totalInvoices = invoices.length;
            const paidInvoices = invoices.filter(inv => inv.status === 'Paid').length;
            const pendingInvoices = invoices.filter(inv => inv.status === 'Pending').length;
            const totalCollected = invoices.reduce((sum, inv) => sum + calculateTotalCollected(inv), 0);
            
            const totalInvoicesEl = document.getElementById('totalInvoices');
            const paidInvoicesEl = document.getElementById('paidInvoices');
            const pendingInvoicesEl = document.getElementById('pendingInvoices');
            const totalAmountEl = document.getElementById('totalInvoiceAmount');
            
            if (totalInvoicesEl) totalInvoicesEl.textContent = totalInvoices;
            if (paidInvoicesEl) paidInvoicesEl.textContent = paidInvoices;
            if (pendingInvoicesEl) pendingInvoicesEl.textContent = pendingInvoices;
            if (totalAmountEl) totalAmountEl.textContent = `KSh ${totalCollected.toLocaleString()}`;
        }

        // Preview invoice
        function previewInvoice() {
            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Please select a client first');
                return;
            }
            
            // Collect invoice data
            const items = [];
            const itemElements = document.querySelectorAll('.invoice-item');
            itemElements.forEach(item => {
                const description = item.querySelector('input[placeholder="Item description"]').value;
                const quantity = parseFloat(item.querySelector('input[placeholder="Quantity"]').value) || 0;
                const rate = parseFloat(item.querySelector('input[placeholder="Rate"]').value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate > 0) {
                    items.push({ description, quantity, rate, amount });
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one invoice item');
                return;
            }
            
            const invoiceData = {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                client: client,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                description: document.getElementById('invoiceDescription').value,
                items: items,
                subtotal: parseFloat(document.getElementById('invoiceSubtotal').textContent.replace('KSh ', '')),
                taxRate: parseFloat(document.getElementById('taxRate').value),
                tax: parseFloat(document.getElementById('invoiceTax').textContent.replace('KSh ', '')),
                discount: parseFloat(document.getElementById('discount').value),
                total: parseFloat(document.getElementById('invoiceTotal').textContent.replace('KSh ', '')),
                notes: document.getElementById('notes').value
            };
            
            // Show preview modal
            showInvoicePreview(invoiceData);
        }

        // Show invoice preview modal
        function showInvoicePreview(invoiceData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 10px;
                    max-width: 800px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                    ">
                        <h2 style="margin: 0; color: var(--primary);">Invoice Preview</h2>
                        <button onclick="this.closest('.modal').remove()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                        ">&times;</button>
                    </div>
                    
                    <div style="padding: 20px; border: 1px solid #ddd; background: white; font-family: Arial, sans-serif;">
                        <!-- Invoice Header -->
                        <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <h1 style="color: #191970; margin: 0; font-size: 20px; font-weight: bold;">${companyDetails.name}</h1>
                                    ${companyDetails.tagline ? `<p style="color: #666; margin: 5px 0; font-size: 12px;">${companyDetails.tagline}</p>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <h2 style="color: #87CEEB; margin: 0; font-size: 28px; font-weight: bold;">INVOICE</h2>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Client Details and Invoice Info -->
                        <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <p style="color: #333; margin: 5px 0; font-size: 14px;">Invoice to :</p>
                                    <p style="margin: 5px 0; font-weight: bold; font-size: 16px;">${invoiceData.client.name}</p>
                                    ${invoiceData.client.phone ? `<p style="margin: 2px 0; font-size: 12px;">Phone: ${invoiceData.client.phone}</p>` : ''}
                                    <p style="margin: 2px 0; font-size: 12px;">Email: ${invoiceData.client.email}</p>
                                    ${invoiceData.client.address ? `<p style="margin: 2px 0; font-size: 12px;">Address: ${invoiceData.client.address}</p>` : ''}
                                </div>
                                <div style="text-align: right; flex: 1; min-width: 200px;">
                                    <p style="margin: 5px 0; font-size: 14px;">Invoice no : ${invoiceData.invoiceNumber}</p>
                                    <p style="margin: 5px 0; font-size: 14px;">Date : ${new Date(invoiceData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Items Table -->
                        <div style="margin-bottom: 30px; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; min-width: 500px;">
                                <thead>
                                    <tr style="background: #191970;">
                                        <th style="padding: 10px 6px; text-align: left; color: white; font-weight: bold; font-size: 11px; width: 40px;">NO</th>
                                        <th style="padding: 10px 6px; text-align: left; color: white; font-weight: bold; font-size: 11px;">DESCRIPTION</th>
                                        <th style="padding: 10px 6px; text-align: center; color: white; font-weight: bold; font-size: 11px; width: 50px;">QTY</th>
                                        <th style="padding: 10px 6px; text-align: right; color: white; font-weight: bold; font-size: 11px; width: 70px;">PRICE</th>
                                        <th style="padding: 10px 6px; text-align: right; color: white; font-weight: bold; font-size: 11px; width: 80px;">TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoiceData.items.map((item, index) => `
                                        <tr style="background: ${index % 2 === 0 ? '#f0f8ff' : 'white'};">
                                            <td style="padding: 8px 6px; font-size: 11px;">${index + 1}</td>
                                            <td style="padding: 8px 6px; font-size: 11px; word-wrap: break-word;">${item.description}</td>
                                            <td style="padding: 8px 6px; text-align: center; font-size: 11px;">${item.quantity}</td>
                                            <td style="padding: 8px 6px; text-align: right; font-size: 11px;">KSh ${item.rate.toFixed(2)}</td>
                                            <td style="padding: 8px 6px; text-align: right; font-size: 11px; font-weight: bold;">KSh ${item.amount.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Totals -->
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 30px;">
                            <div style="width: 100%; max-width: 300px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px;">
                                    <span>Sub Total :</span>
                                    <span>KSh ${invoiceData.subtotal.toFixed(2)}</span>
                                </div>
                                ${invoiceData.tax > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px;">
                                        <span>Tax ${invoiceData.taxRate}% :</span>
                                        <span>KSh ${invoiceData.tax.toFixed(2)}</span>
                                    </div>
                                ` : ''}
                                ${invoiceData.discount > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px;">
                                        <span>Discount :</span>
                                        <span>-KSh ${invoiceData.discount.toFixed(2)}</span>
                                    </div>
                                ` : ''}
                                <!-- Grand Total with dark blue background -->
                                <div style="background: #191970; color: white; padding: 10px; margin-top: 10px; border-radius: 3px;">
                                    <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: bold;">
                                        <span>GRAND TOTAL :</span>
                                        <span>KSh ${invoiceData.total.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method -->
                        <div style="margin-bottom: 20px;">
                            <div style="background: #191970; color: white; padding: 15px; width: 100%; max-width: 250px; border-radius: 3px;">
                                <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 12px;">PAYMENT METHOD :</p>
                                <p style="margin: 0; font-size: 12px;">Send Money Via Mpesa</p>
                            </div>
                            <p style="margin: 10px 0; font-size: 12px;">Number : ${companyDetails.phone || '+254 793 520615'}</p>
                        </div>
                        
                        <!-- Separator line -->
                        <div style="border-top: 1px solid #ddd; margin: 20px 0;"></div>
                        
                        <!-- Thank you and terms -->
                        <div style="margin-bottom: 20px;">
                            <p style="margin: 5px 0; font-size: 13px;">Thank you for doing business with us!</p>
                            <p style="margin: 5px 0; font-size: 13px;">Term and Conditions :</p>
                            <p style="margin: 5px 0; font-size: 12px; color: #666;">50% deposit should be made & balance paid upon completion</p>
                        </div>
                        
                        <!-- Footer with contact info -->
                        <div style="border-top: 2px solid #87CEEB; padding-top: 15px; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: end; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <p style="margin: 2px 0; font-size: 11px;"> ${companyDetails.phone || '0793 520615'}</p>
                                    <p style="margin: 2px 0; font-size: 11px;"> ${companyDetails.email || 'noveyotechnologies@gmail.com'}</p>
                                    <p style="margin: 2px 0; font-size: 11px;"> @noveyotech</p>
                                </div>
                                <div style="text-align: right; flex: 1; min-width: 150px;">
                                    <p style="margin: 2px 0; font-size: 12px; font-weight: bold;">${companyDetails.name}</p>
                                    <p style="margin: 2px 0; font-size: 11px;">Accounts Department</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="
                        display: flex;
                        gap: 10px;
                        padding: 20px;
                        border-top: 1px solid #eee;
                        justify-content: flex-end;
                    ">
                        <button onclick="this.closest('.modal').remove()" style="
                            padding: 10px 20px;
                            background: var(--gray);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">Close</button>
                        <button onclick="generatePDFFromPreview(); this.closest('.modal').remove()" style="
                            padding: 10px 20px;
                            background: var(--primary);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">Download PDF</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Store invoice data for PDF generation
            window.previewInvoiceData = invoiceData;
        }

        // Generate PDF from preview
        function generatePDFFromPreview() {
            if (window.previewInvoiceData) {
                generateInvoicePDF(window.previewInvoiceData);
            }
        }

        // Generate PDF
        function generatePDF() {
            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Please select a client first');
                return;
            }
            
            // Collect invoice data
            const items = [];
            const itemElements = document.querySelectorAll('.invoice-item');
            itemElements.forEach(item => {
                const description = item.querySelector('input[placeholder="Item description"]').value;
                const quantity = parseFloat(item.querySelector('input[placeholder="Quantity"]').value) || 0;
                const rate = parseFloat(item.querySelector('input[placeholder="Rate"]').value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate > 0) {
                    items.push({ description, quantity, rate, amount });
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one invoice item');
                return;
            }
            
            const invoiceData = {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                client: client,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                description: document.getElementById('invoiceDescription').value,
                items: items,
                subtotal: parseFloat(document.getElementById('invoiceSubtotal').textContent.replace('KSh ', '')),
                taxRate: parseFloat(document.getElementById('taxRate').value),
                tax: parseFloat(document.getElementById('invoiceTax').textContent.replace('KSh ', '')),
                discount: parseFloat(document.getElementById('discount').value),
                total: parseFloat(document.getElementById('invoiceTotal').textContent.replace('KSh ', '')),
                notes: document.getElementById('notes').value
            };
            
            // Generate PDF using jsPDF
            generateInvoicePDF(invoiceData);
        }

        // Generate standardized invoice PDF
        function generateInvoicePDF(invoiceData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up the standardized invoice template
            generateStandardizedInvoice(doc, invoiceData);
            
            // Save the PDF
            doc.save(`invoice-${invoiceData.invoiceNumber}.pdf`);
            
            showNotification('PDF generated successfully!', 'success');
        }

        // Generate standardized invoice template matching the sample format
        function generateStandardizedInvoice(doc, invoiceData) {
            // Page setup - using A4 dimensions for consistent layout
            const pageWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const margin = 15; // Reduced margin for more compact layout
            const contentWidth = pageWidth - (margin * 2);
            
            // Colors matching the sample
            const darkBlue = [25, 25, 112]; // Dark blue for headers
            const lightBlue = [135, 206, 235]; // Light blue for accents
            
            // Helper function to check if we need a new page
            function checkPageBreak(requiredSpace) {
                if (yPos + requiredSpace > pageHeight - 20) {
                    doc.addPage();
                    yPos = 15;
                    return true;
                }
                return false;
            }
            
            // Helper function to wrap text
            function wrapText(text, maxWidth, fontSize) {
                doc.setFontSize(fontSize);
                return doc.splitTextToSize(text, maxWidth);
            }
            
            let yPos = 15;
            
            // Header Section with Logo and Company Info
            // Add logo if available (left side)
            try {
                if (companyDetails.logoUrl) {
                    doc.addImage(companyDetails.logoUrl, 'PNG', margin, yPos, 25, 15);
                }
            } catch (error) {
                console.log('Could not load logo:', error);
            }
            
            // Company name and tagline (right of logo) - properly aligned to left margin
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...darkBlue);
            doc.text(companyDetails.name, margin, yPos + 12);
            
            if (companyDetails.tagline) {
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(companyDetails.tagline, margin, yPos + 20);
            }
            
            // Invoice title (top right)
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...lightBlue);
            doc.text('INVOICE', pageWidth - 50, 20);
            
            // Separator line
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, 40, pageWidth - margin, 40);
            yPos = 45;
            
            // Invoice To section (left side)
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text('Invoice to :', margin, yPos);
            yPos += 6;
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(invoiceData.client.name, margin, yPos);
            yPos += 6;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            if (invoiceData.client.phone) {
                doc.text(`Phone: ${invoiceData.client.phone}`, margin, yPos);
                yPos += 4;
            }
            doc.text(`Email: ${invoiceData.client.email}`, margin, yPos);
            yPos += 4;
            if (invoiceData.client.address) {
                const addressLines = wrapText(`Address: ${invoiceData.client.address}`, 80, 9);
                addressLines.forEach(line => {
                    doc.text(line, margin, yPos);
                    yPos += 4;
                });
            }
            
            // Invoice number and date (right side)
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Invoice no : ${invoiceData.invoiceNumber}`, pageWidth - 70, 45);
            doc.text(`Date : ${new Date(invoiceData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`, pageWidth - 70, 55);
            
            yPos += 10;
            
            // Check if we need a new page for the table
            checkPageBreak(40);
            
            // Items table - more compact layout
            const tableStartY = yPos;
            const tableWidth = contentWidth;
            const colWidths = {
                no: 10,
                description: tableWidth - 80,
                qty: 15,
                price: 25,
                total: 30
            };
            
            // Table header with dark blue background
            doc.setFillColor(...darkBlue);
            doc.rect(margin, tableStartY, tableWidth, 10, 'F');
            
            // Header text in white
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('NO', margin + 1, tableStartY + 6);
            doc.text('DESCRIPTION', margin + colWidths.no + 2, tableStartY + 6);
            doc.text('QTY', margin + colWidths.no + colWidths.description + 2, tableStartY + 6);
            doc.text('PRICE', margin + colWidths.no + colWidths.description + colWidths.qty + 2, tableStartY + 6);
            doc.text('TOTAL', margin + colWidths.no + colWidths.description + colWidths.qty + colWidths.price + 2, tableStartY + 6);
            
            yPos = tableStartY + 10;
            
            // Table rows with alternating colors
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            
            invoiceData.items.forEach((item, index) => {
                // Check if we need a new page
                if (checkPageBreak(12)) {
                    // Redraw table header on new page
                    doc.setFillColor(...darkBlue);
                    doc.rect(margin, yPos, tableWidth, 10, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NO', margin + 1, yPos + 6);
                    doc.text('DESCRIPTION', margin + colWidths.no + 2, yPos + 6);
                    doc.text('QTY', margin + colWidths.no + colWidths.description + 2, yPos + 6);
                    doc.text('PRICE', margin + colWidths.no + colWidths.description + colWidths.qty + 2, yPos + 6);
                    doc.text('TOTAL', margin + colWidths.no + colWidths.description + colWidths.qty + colWidths.price + 2, yPos + 6);
                    yPos += 10;
                }
                
                // Alternate row colors
                if (index % 2 === 0) {
                    doc.setFillColor(240, 248, 255); // Very light blue
                    doc.rect(margin, yPos, tableWidth, 8, 'F');
                } else {
                    doc.setFillColor(255, 255, 255); // White
                    doc.rect(margin, yPos, tableWidth, 8, 'F');
                }
                
                // Item number
                doc.text((index + 1).toString(), margin + 1, yPos + 5);
                
                // Description (wrap if too long)
                const descLines = wrapText(item.description, colWidths.description - 3, 8);
                descLines.forEach((line, lineIndex) => {
                    doc.text(line, margin + colWidths.no + 2, yPos + 5 + (lineIndex * 3));
                });
                
                // Quantity
                doc.text(item.quantity.toString(), margin + colWidths.no + colWidths.description + 2, yPos + 5);
                
                // Price
                doc.text(`KSh ${item.rate.toFixed(2)}`, margin + colWidths.no + colWidths.description + colWidths.qty + 2, yPos + 5);
                
                // Total
                doc.text(`KSh ${item.amount.toFixed(2)}`, margin + colWidths.no + colWidths.description + colWidths.qty + colWidths.price + 2, yPos + 5);
                
                yPos += Math.max(10, descLines.length * 3 + 2);
            });
            
            // Summary section
            yPos += 8;
            const summaryX = pageWidth - 60;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Sub Total :', summaryX - 20, yPos);
            doc.text(`KSh ${invoiceData.subtotal.toFixed(2)}`, summaryX, yPos);
            yPos += 5;
            
            if (invoiceData.tax > 0) {
                doc.text(`Tax ${invoiceData.taxRate}% :`, summaryX - 20, yPos);
                doc.text(`KSh ${invoiceData.tax.toFixed(2)}`, summaryX, yPos);
                yPos += 5;
            }
            
            if (invoiceData.discount > 0) {
                doc.text('Discount :', summaryX - 20, yPos);
                doc.text(`-KSh ${invoiceData.discount.toFixed(2)}`, summaryX, yPos);
                yPos += 5;
            }
            
            // Grand Total with dark blue background
            doc.setFillColor(...darkBlue);
            doc.rect(summaryX - 30, yPos - 2, 60, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('GRAND TOTAL :', summaryX - 25, yPos + 3);
            doc.text(`KSh ${invoiceData.total.toFixed(2)}`, summaryX + 5, yPos + 3);
            
            yPos += 15;
            
            // Check if we need a new page for payment section
            checkPageBreak(30);
            
            // Payment Method section
            doc.setFillColor(...darkBlue);
            doc.rect(margin, yPos, 45, 12, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('PAYMENT METHOD :', margin + 2, yPos + 5);
            doc.text('Send Money Via Mpesa', margin + 2, yPos + 9);
            
            // Payment details
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(`Number : ${companyDetails.phone || '+254 793 520615'}`, margin, yPos + 16);
            
            yPos += 25;
            
            // Separator line
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // Thank you message
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Thank you for doing business with us!', margin, yPos);
            yPos += 6;
            
            // Terms and conditions
            doc.setFontSize(10);
            doc.text('Term and Conditions :', margin, yPos);
            yPos += 6;
            const termsText = '50% deposit should be made & balance paid upon completion';
            const termsLines = wrapText(termsText, contentWidth, 9);
            termsLines.forEach(line => {
                doc.text(line, margin, yPos);
                yPos += 5;
            });
            
            // Footer with contact info
            const footerY = pageHeight - 25;
            
            // Light blue line
            doc.setDrawColor(...lightBlue);
            doc.line(margin, footerY, margin + 60, footerY);
            
            // Contact information
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`${companyDetails.phone || '0793 520615'}`, margin, footerY + 6);
            doc.text(`${companyDetails.email || 'noveyotechnologies@gmail.com'}`, margin, footerY + 11);
            doc.text('@noveyotech', margin, footerY + 16);
            
            // Company signature
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(companyDetails.name, pageWidth - 50, footerY + 6);
            doc.setFont('helvetica', 'normal');
            doc.text('Accounts Department', pageWidth - 50, footerY + 11);
        }

        // Render invoices table
        function renderInvoicesTable() {
            if (!invoices || invoices.length === 0) {
                return `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            No invoices created yet. <a href="#" onclick="showCreateInvoiceForm()" style="color: var(--primary);">Create your first invoice</a>
                        </td>
                    </tr>
                `;
            }

            return invoices.map(invoice => {
                const totalCollected = calculateTotalCollected(invoice);
                return `
                <tr>
                    <td>
                        <strong>${invoice.invoiceNumber}</strong>
                    </td>
                    <td>
                        <div>
                            <strong>${invoice.clientName}</strong>
                            <br><small style="color: #666;">${invoice.clientEmail}</small>
                        </div>
                    </td>
                    <td>KSh ${totalCollected.toLocaleString()}</td>
                    <td>${new Date(invoice.date).toLocaleDateString()}</td>
                    <td>
                        <select class="form-control" style="width: 120px; font-size: 12px; padding: 4px;" onchange="updateInvoiceStatus(${invoice.id}, this.value)">
                            <option value="Pending" ${invoice.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Paid" ${invoice.status === 'Paid' ? 'selected' : ''}>Paid</option>
                            <option value="Overdue" ${invoice.status === 'Overdue' ? 'selected' : ''}>Overdue</option>
                            <option value="Cancelled" ${invoice.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <i class="fas fa-eye" style="color: var(--primary); cursor: pointer; margin-right: 10px;" onclick="viewInvoice(${invoice.id})" title="View Invoice"></i>
                        <i class="fas fa-download" style="color: var(--success); cursor: pointer; margin-right: 10px;" onclick="downloadInvoicePDF(${invoice.id})" title="Download PDF"></i>
                        <i class="fas fa-edit" style="color: var(--warning); cursor: pointer;" onclick="editInvoice(${invoice.id})" title="Edit Invoice"></i>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // View invoice
        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            // Convert stored invoice to preview format
            const client = clients.find(c => c.id === invoice.clientId);
            if (!client) {
                alert('Client not found');
                return;
            }

            const invoiceData = {
                invoiceNumber: invoice.invoiceNumber,
                client: client,
                date: invoice.date,
                dueDate: invoice.dueDate,
                description: invoice.description,
                items: invoice.items,
                subtotal: invoice.subtotal,
                taxRate: invoice.taxRate,
                tax: invoice.tax,
                discount: invoice.discount,
                total: invoice.total,
                notes: invoice.notes
            };

            // Show preview modal
            showInvoicePreview(invoiceData);
        }

        // Download invoice PDF
        function downloadInvoicePDF(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            // Convert stored invoice to PDF format
            const client = clients.find(c => c.id === invoice.clientId);
            if (!client) {
                alert('Client not found');
                return;
            }

            const invoiceData = {
                invoiceNumber: invoice.invoiceNumber,
                client: client,
                date: invoice.date,
                dueDate: invoice.dueDate,
                description: invoice.description,
                items: invoice.items,
                subtotal: invoice.subtotal,
                taxRate: invoice.taxRate,
                tax: invoice.tax,
                discount: invoice.discount,
                total: invoice.total,
                notes: invoice.notes
            };

            // Generate PDF for existing invoice
            generateInvoicePDF(invoiceData);
        }

        // Edit invoice
        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            // Show edit form with pre-filled data
            showCreateInvoiceForm();
            
            // Wait for form to load, then fill it
            setTimeout(() => {
                fillInvoiceForm(invoice);
            }, 100);
        }

        // Fill invoice form for editing
        function fillInvoiceForm(invoice) {
            document.getElementById('invoiceClient').value = invoice.clientId;
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('dueDate').value = invoice.dueDate;
            document.getElementById('invoiceDescription').value = invoice.description;
            document.getElementById('taxRate').value = invoice.taxRate;
            document.getElementById('discount').value = invoice.discount;
            document.getElementById('notes').value = invoice.notes || '';

            // Clear existing items
            const itemsContainer = document.getElementById('invoiceItems');
            itemsContainer.innerHTML = '';

            // Add invoice items
            invoice.items.forEach(item => {
                addInvoiceItem();
                const lastItem = itemsContainer.lastElementChild;
                lastItem.querySelector('input[placeholder="Item description"]').value = item.description;
                lastItem.querySelector('input[placeholder="Quantity"]').value = item.quantity;
                lastItem.querySelector('input[placeholder="Rate"]').value = item.rate;
            });

            // Recalculate totals
            calculateInvoiceTotal();

            // Update form to edit mode
            const submitBtn = document.querySelector('#invoiceForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Invoice';
                submitBtn.onclick = (e) => {
                    e.preventDefault();
                    updateInvoice(invoice.id);
                };
            }
        }

        // Update invoice
        function updateInvoice(id) {
            const invoiceIndex = invoices.findIndex(inv => inv.id === id);
            if (invoiceIndex === -1) return;

            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Please select a client');
                return;
            }
            
            // Collect invoice items
            const items = [];
            const itemElements = document.querySelectorAll('.invoice-item');
            itemElements.forEach(item => {
                const description = item.querySelector('input[placeholder="Item description"]').value;
                const quantity = parseFloat(item.querySelector('input[placeholder="Quantity"]').value) || 0;
                const rate = parseFloat(item.querySelector('input[placeholder="Rate"]').value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate > 0) {
                    items.push({ description, quantity, rate, amount });
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one invoice item');
                return;
            }
            
            invoices[invoiceIndex] = {
                ...invoices[invoiceIndex],
                clientId: clientId,
                clientName: client.name,
                clientEmail: client.email,
                clientPhone: client.phone,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                description: document.getElementById('invoiceDescription').value,
                items: items,
                subtotal: parseFloat(document.getElementById('invoiceSubtotal').textContent.replace('KSh ', '')),
                taxRate: parseFloat(document.getElementById('taxRate').value),
                tax: parseFloat(document.getElementById('invoiceTax').textContent.replace('KSh ', '')),
                discount: parseFloat(document.getElementById('discount').value),
                total: parseFloat(document.getElementById('invoiceTotal').textContent.replace('KSh ', '')),
                notes: document.getElementById('notes').value,
                status: invoices[invoiceIndex].status || 'Pending'
            };
            
            localStorage.setItem('invoices', JSON.stringify(invoices));
            showNotification('Invoice updated successfully!', 'success');
            showInvoices();
        }

        // Delete invoice
        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                invoices = invoices.filter(inv => inv.id !== id);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                showInvoices();
                showNotification('Invoice deleted successfully!', 'success');
            }
        }

        // Update invoice status
        function updateInvoiceStatus(id, newStatus) {
            const invoiceIndex = invoices.findIndex(inv => inv.id === id);
            if (invoiceIndex !== -1) {
                invoices[invoiceIndex].status = newStatus;
                localStorage.setItem('invoices', JSON.stringify(invoices));
                updateInvoiceStats();
                showNotification(`Invoice status updated to ${newStatus}`, 'success');
                
                // Refresh the invoices table to show updated status
                const tbody = document.getElementById('invoicesTableBody');
                if (tbody) {
                    tbody.innerHTML = renderInvoicesTable();
                }
            }
        }

        // Edit company details
        function editCompanyDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 10px;
                    max-width: 600px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                    ">
                        <h2 style="margin: 0; color: var(--primary);">Edit Company Details</h2>
                        <button onclick="this.closest('.modal').remove()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                        ">&times;</button>
                    </div>
                    
                    <div style="padding: 30px;">
                        <form id="companyDetailsForm">
                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <input type="text" class="form-control" id="companyName" value="${companyDetails.name}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="companyTagline">Tagline</label>
                                <input type="text" class="form-control" id="companyTagline" value="${companyDetails.tagline}">
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="companyEmail">Email</label>
                                        <input type="email" class="form-control" id="companyEmail" value="${companyDetails.email}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="companyPhone">Phone</label>
                                        <input type="tel" class="form-control" id="companyPhone" value="${companyDetails.phone}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="companyWebsite">Website</label>
                                        <input type="url" class="form-control" id="companyWebsite" value="${companyDetails.website}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="companyAddress">Address</label>
                                        <input type="text" class="form-control" id="companyAddress" value="${companyDetails.address}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="paymentTerms">Payment Terms</label>
                                <input type="text" class="form-control" id="paymentTerms" value="${companyDetails.paymentTerms}">
                            </div>
                            
                            <div class="form-group">
                                <label for="logoUrl">Logo URL/Path</label>
                                <input type="text" class="form-control" id="logoUrl" value="${companyDetails.logoUrl}" placeholder="e.g., logo.png or https://example.com/logo.png">
                                <small style="color: #666;">Enter the path to your logo file or a URL</small>
                            </div>
                        </form>
                    </div>
                    
                    <div style="
                        display: flex;
                        gap: 10px;
                        padding: 20px;
                        border-top: 1px solid #eee;
                        justify-content: flex-end;
                    ">
                        <button onclick="this.closest('.modal').remove()" style="
                            padding: 10px 20px;
                            background: var(--gray);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">Cancel</button>
                        <button onclick="saveCompanyDetails(); this.closest('.modal').remove()" style="
                            padding: 10px 20px;
                            background: var(--primary);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">Save Changes</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
        }

        // Save company details
        function saveCompanyDetails() {
            companyDetails = {
                name: document.getElementById('companyName').value,
                tagline: document.getElementById('companyTagline').value,
                email: document.getElementById('companyEmail').value,
                phone: document.getElementById('companyPhone').value,
                website: document.getElementById('companyWebsite').value,
                address: document.getElementById('companyAddress').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                logoUrl: document.getElementById('logoUrl').value
            };
            
            localStorage.setItem('companyDetails', JSON.stringify(companyDetails));
            showNotification('Company details updated successfully!', 'success');
        }

        // Tab functionality
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.textContent.trim();
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    if (target === 'Client Management') {
                        document.querySelectorAll('.tab-content')[0].classList.add('active');
                    } else if (target === 'Outreach Tracking') {
                        document.querySelectorAll('.tab-content')[1].classList.add('active');
                    }
                });
            });
        }

        // Form functionality
        function initializeForms() {
            // Client form
            const clientForm = document.querySelector('form');
            if (clientForm) {
                clientForm.addEventListener('submit', handleClientSubmit);
            }

            // Prospect form
            const prospectForm = document.querySelectorAll('form')[1];
            if (prospectForm) {
                prospectForm.addEventListener('submit', handleProspectSubmit);
            }

            // New Client button
            const newClientBtn = document.querySelector('.btn-primary');
            if (newClientBtn && newClientBtn.textContent.includes('New Client')) {
                newClientBtn.addEventListener('click', () => {
                    // Switch to client management tab
                    document.querySelectorAll('.tab')[0].click();
                    // Scroll to form
                    document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
                });
            }
        }

        function handleClientSubmit(e) {
            e.preventDefault();
            
            const projectValue = parseFloat(document.getElementById('projectValue').value) || 0;
            const paymentStatus = document.getElementById('paymentStatus').value;
            const engagementType = document.querySelector('input[name="engagementType"]:checked')?.value || '';
            const clientStatus = document.getElementById('clientStatus').value;
            
            const clientData = {
                id: Date.now(),
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                service: document.getElementById('serviceType').value,
                type: engagementType,
                contractDuration: engagementType === 'contract' ? document.getElementById('contractDuration').value : null,
                value: projectValue,
                paymentStatus: paymentStatus,
                paidAmount: paymentStatus === 'fully-paid' ? projectValue : paymentStatus === 'deposit' ? Math.floor(projectValue * 0.5) : 0,
                status: clientStatus,
                monthlyPayments: []
            };

            // Validate form
            if (!clientData.name || !clientData.email || !clientData.service || !clientData.type) {
                alert('Please fill in all required fields');
                return;
            }

            // Add client
            clients.push(clientData);
            saveData();
            
            // Clear form
            e.target.reset();
            
            // Update UI - always go back to clients list
            showClients();
            updateStats();
            
            // Show success message
            showNotification('Client added successfully!', 'success');
        }

        function handleProspectSubmit(e) {
            e.preventDefault();
            
            const prospectData = {
                id: Date.now(),
                name: document.getElementById('prospectName').value,
                company: document.getElementById('prospectCompany').value,
                email: document.getElementById('prospectEmail').value,
                phone: document.getElementById('prospectPhone').value,
                service: document.getElementById('proposedService').value,
                proposalSent: document.getElementById('proposalSent').value || new Date().toISOString().split('T')[0],
                response: document.getElementById('prospectResponse').value,
                status: document.getElementById('prospectStatus').value
            };

            // Validate form
            if (!prospectData.name || !prospectData.email || !prospectData.service) {
                alert('Please fill in all required fields');
                return;
            }

            // Add prospect
            prospects.push(prospectData);
            saveData();
            
            // Clear form
            e.target.reset();
            
            // Update UI - go back to outreach page
            showOutreach();
            updateStats();
            
            // Show success message
            showNotification('Prospect added successfully!', 'success');
        }

        // Search functionality
        function initializeSearch() {
            const searchInput = document.querySelector('input[placeholder="Search..."]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterTables(searchTerm);
                });
            }
        }

        function filterTables(searchTerm) {
            // Filter client table
            const clientRows = document.querySelectorAll('tbody tr');
            clientRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterProspectTable(searchTerm) {
            // Filter prospect table
            const prospectRows = document.querySelectorAll('tbody tr');
            prospectRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Table rendering and actions
        function renderClientTable() {
            if (!clients || clients.length === 0) return '';

            return clients.map(client => `
                <tr>
                    <td>
                        <div>
                            <strong>${client.name || 'N/A'}</strong>
                            <br><small style="color: #666;">${client.email || 'N/A'}</small>
                            <br><small style="color: #666;">${client.phone || 'N/A'}</small>
                        </div>
                    </td>
                    <td>${client.service || 'N/A'}</td>
                    <td>
                        ${client.type || 'N/A'}
                        ${client.contractDuration ? `<br><small style="color: #666;">${client.contractDuration}</small>` : ''}
                    </td>
                    <td>KSh ${(client.value || 0).toLocaleString()}</td>
                    <td class="${client.paymentStatus === 'fully-paid' ? 'text-success' : client.paymentStatus === 'pending' ? 'text-warning' : 'text-warning'}">
                        ${client.paymentStatus === 'fully-paid' ? 'Fully Paid' : client.paymentStatus === 'pending' ? 'Pending' : 'Deposit (50%)'}
                        <br><small>KSh ${(client.paidAmount || 0).toLocaleString()} paid</small>
                        ${client.monthlyPayments && client.monthlyPayments.length > 0 ? `<br><small style="color: #666;">${client.monthlyPayments.length} payments</small>` : ''}
                    </td>
                    <td>
                        <select class="form-control" style="width: 120px; font-size: 12px; padding: 4px;" onchange="updateClientStatus(${client.id}, this.value)">
                            <option value="Active" ${client.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Paused" ${client.status === 'Paused' ? 'selected' : ''}>Paused</option>
                            <option value="Closed" ${client.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </td>
                    <td>
                        <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;" onclick="editClient(${client.id})"></i>
                    </td>
                </tr>
            `).join('');
        }

        function renderProspectTable() {
            if (!prospects || prospects.length === 0) return '';

            return prospects.map(prospect => `
                <tr>
                    <td>
                        <div>
                            <strong>${prospect.name || 'N/A'}</strong>
                            <br><small style="color: #666;">${prospect.phone || 'N/A'}</small>
                        </div>
                    </td>
                    <td>${prospect.company || 'N/A'}</td>
                    <td>${prospect.email || 'N/A'}</td>
                    <td>${prospect.service || 'N/A'}</td>
                    <td>${prospect.proposalSent || 'N/A'}</td>
                    <td>${prospect.response || 'N/A'}</td>
                    <td><span class="status-badge status-${(prospect.status || 'Awaiting Response').toLowerCase().replace(' ', '-')}">${prospect.status || 'Awaiting Response'}</span></td>
                    <td>
                        <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;" onclick="editProspect(${prospect.id})"></i>
                        <i class="fas fa-trash" style="color: var(--danger); cursor: pointer; margin-left: 10px;" onclick="deleteProspect(${prospect.id})"></i>
                    </td>
                </tr>
            `).join('');
        }


        // Client actions
        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            // Set current editing client for payment tracking
            window.currentEditingClient = client;
            
            // Show the add client form in edit mode
            showAddClientForm();
            
            // Wait for DOM to update, then fill form
            setTimeout(() => {
                fillClientForm(client, id);
            }, 100);
        }

        function fillClientForm(client, id) {
            // Update page title to show editing
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                pageTitle.textContent = 'Edit Client';
            }

            // Fill form with client data
            const nameField = document.getElementById('clientName');
            const emailField = document.getElementById('clientEmail');
            const phoneField = document.getElementById('clientPhone');
            const serviceField = document.getElementById('serviceType');
            const valueField = document.getElementById('projectValue');
            const paymentStatusField = document.getElementById('paymentStatus');
            const clientStatusField = document.getElementById('clientStatus');
            const contractDurationField = document.getElementById('contractDuration');
            
            if (nameField) nameField.value = client.name || '';
            if (emailField) emailField.value = client.email || '';
            if (phoneField) phoneField.value = client.phone || '';
            if (serviceField) serviceField.value = client.service || '';
            if (valueField) valueField.value = client.value || '';
            if (paymentStatusField) paymentStatusField.value = client.paymentStatus || 'deposit';
            if (clientStatusField) clientStatusField.value = client.status || 'Active';
            if (contractDurationField && client.contractDuration) contractDurationField.value = client.contractDuration;
            
            // Handle radio buttons
            const contractRadio = document.querySelector('input[name="engagementType"][value="contract"]');
            const onetimeRadio = document.querySelector('input[name="engagementType"][value="onetime"]');
            
            if (contractRadio && onetimeRadio) {
                if (client.type === 'Contract') {
                    contractRadio.checked = true;
                } else if (client.type === 'One-Time') {
                    onetimeRadio.checked = true;
                }
            }

            // Toggle contract options based on engagement type
            toggleContractOptions();
            togglePaymentTracking();

            // Update payment tracking display
            updatePaymentTrackingDisplay();
            updatePaymentHistory();

            // Scroll to form
            const form = document.querySelector('form');
            if (form) {
                form.scrollIntoView({ behavior: 'smooth' });
            }

            // Update form to edit mode
            const submitBtn = document.querySelector('form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Client';
                submitBtn.onclick = (e) => {
                    e.preventDefault();
                    updateClient(id);
                };
            }
        }

        function updateClient(id) {
            const clientIndex = clients.findIndex(c => c.id === id);
            if (clientIndex === -1) return;

            const nameField = document.getElementById('clientName');
            const emailField = document.getElementById('clientEmail');
            const phoneField = document.getElementById('clientPhone');
            const serviceField = document.getElementById('serviceType');
            const valueField = document.getElementById('projectValue');
            const paymentStatusField = document.getElementById('paymentStatus');
            const clientStatusField = document.getElementById('clientStatus');
            const engagementType = document.querySelector('input[name="engagementType"]:checked');
            const contractDurationField = document.getElementById('contractDuration');

            const projectValue = valueField ? parseFloat(valueField.value) || 0 : 0;
            const newPaymentStatus = paymentStatusField ? paymentStatusField.value : 'deposit';
            const newClientStatus = clientStatusField ? clientStatusField.value : 'Active';
            const engagementTypeValue = engagementType ? engagementType.value : '';

            // Calculate new paid amount based on payment status
            let newPaidAmount;
            if (newPaymentStatus === 'fully-paid') {
                newPaidAmount = projectValue;
            } else if (newPaymentStatus === 'deposit') {
                newPaidAmount = Math.floor(projectValue * 0.5);
            } else {
                // For pending status, no payment is recorded
                newPaidAmount = 0;
            }

            clients[clientIndex] = {
                ...clients[clientIndex],
                name: nameField ? nameField.value : '',
                email: emailField ? emailField.value : '',
                phone: phoneField ? phoneField.value : '',
                service: serviceField ? serviceField.value : '',
                type: engagementTypeValue,
                contractDuration: engagementTypeValue === 'contract' && contractDurationField ? contractDurationField.value : null,
                value: projectValue,
                paymentStatus: newPaymentStatus,
                paidAmount: newPaidAmount,
                status: newClientStatus
            };

            saveData();
            
            // Clear current editing client
            window.currentEditingClient = null;
            
            // Go back to clients list
            showClients();
            updateStats();
            
            showNotification('Client updated successfully!', 'success');
        }

        function updateClientStatus(id, newStatus) {
            const clientIndex = clients.findIndex(c => c.id === id);
            if (clientIndex !== -1) {
                clients[clientIndex].status = newStatus;
                saveData();
                updateStats();
                showNotification(`Client status updated to ${newStatus}`, 'success');
                
                // Refresh the clients table to show updated status
                const tbody = document.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = renderClientTable();
                }
            }
        }

        function deleteClient(id) {
            if (confirm('Are you sure you want to delete this client?')) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                
                // Go back to clients list
                showClients();
                updateStats();
                showNotification('Client deleted successfully!', 'success');
            }
        }

        // Show add prospect form
        function showAddProspectForm() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Add New Prospect</h1>
                    <button class="btn" onclick="showOutreach()" style="background: var(--gray); color: white;"><i class="fas fa-arrow-left"></i> Back to Outreach</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Prospect Details</h2>
                    </div>
                    <form>
                        <div class="form-group">
                            <label for="prospectName">Prospect Name</label>
                            <input type="text" class="form-control" id="prospectName" placeholder="Enter prospect name">
                        </div>
                        <div class="form-group">
                            <label for="prospectCompany">Company</label>
                            <input type="text" class="form-control" id="prospectCompany" placeholder="Enter company name">
                        </div>
                        <div class="form-group">
                            <label for="prospectEmail">Email Address</label>
                            <input type="email" class="form-control" id="prospectEmail" placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label for="prospectPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="prospectPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label for="proposedService">Proposed Service</label>
                            <select class="form-control" id="proposedService">
                                <option value="">Select service type</option>
                                <option value="logo">Logo Design</option>
                                <option value="branding">Branding Package</option>
                                <option value="web">Web Design</option>
                                <option value="social">Social Media Graphics</option>
                                <option value="print">Print Design</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="proposalSent">Proposal Sent Date</label>
                            <input type="date" class="form-control" id="proposalSent">
                        </div>
                        <div class="form-group">
                            <label for="prospectResponse">Response</label>
                            <select class="form-control" id="prospectResponse">
                                <option value="No Response">No Response</option>
                                <option value="Interested">Interested</option>
                                <option value="Not Interested">Not Interested</option>
                                <option value="Follow Up Required">Follow Up Required</option>
                                <option value="Meeting Scheduled">Meeting Scheduled</option>
                                <option value="Proposal Under Review">Proposal Under Review</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prospectStatus">Status</label>
                            <select class="form-control" id="prospectStatus">
                                <option value="Awaiting Response">Awaiting Response</option>
                                <option value="In Discussion">In Discussion</option>
                                <option value="Proposal Sent">Proposal Sent</option>
                                <option value="Negotiating">Negotiating</option>
                                <option value="Converted">Converted</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Prospect</button>
                    </form>
                </div>
            `;

            // Set default values for new prospects
            document.getElementById('proposalSent').value = new Date().toISOString().split('T')[0];
            document.getElementById('prospectResponse').value = 'No Response';
            document.getElementById('prospectStatus').value = 'Awaiting Response';

            // Handle form submission for new prospects
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', handleProspectSubmit);
            }
        }

        // Prospect actions
        function editProspect(id) {
            const prospect = prospects.find(p => p.id === id);
            if (!prospect) return;

            // Set current editing prospect
            window.currentEditingProspect = prospect;
            
            // Show the add prospect form in edit mode
            showAddProspectForm();
            
            // Wait for DOM to update, then fill form
            setTimeout(() => {
                fillProspectForm(prospect, id);
            }, 100);
        }

        function fillProspectForm(prospect, id) {
            // Update page title to show editing
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                pageTitle.textContent = 'Edit Prospect';
            }

            // Fill form with prospect data
            document.getElementById('prospectName').value = prospect.name || '';
            document.getElementById('prospectCompany').value = prospect.company || '';
            document.getElementById('prospectEmail').value = prospect.email || '';
            document.getElementById('prospectPhone').value = prospect.phone || '';
            document.getElementById('proposedService').value = prospect.service || '';
            document.getElementById('proposalSent').value = prospect.proposalSent || '';
            document.getElementById('prospectResponse').value = prospect.response || 'No Response';
            document.getElementById('prospectStatus').value = prospect.status || 'Awaiting Response';

            // Update form to edit mode
            const submitBtn = document.querySelector('form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Prospect';
            }
            
            // Remove existing event listener and add new one
            const form = document.querySelector('form');
            if (form) {
                form.removeEventListener('submit', handleProspectSubmit);
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    updateProspect(id);
                });
            }
        }

        function updateProspect(id) {
            const prospectIndex = prospects.findIndex(p => p.id === id);
            if (prospectIndex === -1) return;

            prospects[prospectIndex] = {
                ...prospects[prospectIndex],
                name: document.getElementById('prospectName').value,
                company: document.getElementById('prospectCompany').value,
                email: document.getElementById('prospectEmail').value,
                phone: document.getElementById('prospectPhone').value,
                service: document.getElementById('proposedService').value,
                proposalSent: document.getElementById('proposalSent').value,
                response: document.getElementById('prospectResponse').value,
                status: document.getElementById('prospectStatus').value
            };

            saveData();
            
            // Clear current editing prospect
            window.currentEditingProspect = null;
            
            // Go back to outreach page
            showOutreach();
            updateStats();
            
            showNotification('Prospect updated successfully!', 'success');
        }

        function deleteProspect(id) {
            if (confirm('Are you sure you want to delete this prospect?')) {
                prospects = prospects.filter(p => p.id !== id);
                saveData();
                
                // Go back to outreach page
                showOutreach();
                updateStats();
                showNotification('Prospect deleted successfully!', 'success');
            }
        }

        // Calculate comprehensive client statistics
        function calculateClientStats() {
            const contractClients = clients.filter(c => c.type === 'Contract');
            
            // Only include clients with confirmed payments (not pending) in revenue calculations
            const confirmedPaymentClients = clients.filter(c => c.paymentStatus !== 'pending');
            
            const stats = {
                totalClients: clients.length,
                activeClients: clients.filter(c => c.status === 'Active').length,
                pausedClients: clients.filter(c => c.status === 'Paused').length,
                closedClients: clients.filter(c => c.status === 'Closed').length,
                contractClients: contractClients.length,
                oneTimeClients: clients.filter(c => c.type === 'One-Time').length,
                totalRevenue: confirmedPaymentClients.reduce((sum, client) => sum + (client.paidAmount || 0), 0),
                totalProjectValue: confirmedPaymentClients.reduce((sum, client) => sum + (client.value || 0), 0),
                pendingRevenue: 0,
                contractTypes: {
                    weekly: clients.filter(c => c.contractDuration === 'weekly').length,
                    monthly: clients.filter(c => c.contractDuration === 'monthly').length,
                    quarterly: clients.filter(c => c.contractDuration === 'quarterly').length,
                    yearly: clients.filter(c => c.contractDuration === 'yearly').length
                },
                paymentStatus: {
                    fullyPaid: clients.filter(c => c.paymentStatus === 'fully-paid').length,
                    deposit: clients.filter(c => c.paymentStatus === 'deposit').length,
                    pending: clients.filter(c => c.paymentStatus === 'pending').length
                }
            };

            // Calculate pending revenue (total project value - paid amount) for confirmed payments only
            stats.pendingRevenue = stats.totalProjectValue - stats.totalRevenue;

            return stats;
        }

        // Stats update
        function updateStats() {
            // Only include clients with confirmed payments (not pending) in revenue calculations
            const confirmedPaymentClients = clients.filter(c => c.paymentStatus !== 'pending');
            const totalRevenue = confirmedPaymentClients.reduce((sum, client) => sum + (client.paidAmount || 0), 0);
            const activeClients = clients.filter(c => c.status === 'Active').length;
            const ongoingProjects = clients.filter(c => c.status === 'Active' || c.status === 'Paused').length;
            const pendingProposals = prospects.filter(p => p.status === 'Awaiting Response').length;

            // Update stat cards
            const statCards = document.querySelectorAll('.stat-info h3');
            if (statCards[0]) statCards[0].textContent = `KSh ${totalRevenue.toLocaleString()}`;
            if (statCards[1]) statCards[1].textContent = activeClients;
            if (statCards[2]) statCards[2].textContent = ongoingProjects;
            if (statCards[3]) statCards[3].textContent = pendingProposals;
        }



        // Projects page
        function showProjectsPage() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Projects</h1>
                    <div class="d-flex align-center gap-10">
                        <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                            <input type="text" class="form-control" placeholder="Search projects..." id="projectSearch">
                        </div>
                        <button class="btn btn-primary" onclick="showAddProjectForm()"><i class="fas fa-plus"></i> New Project</button>
                    </div>
                </div>

                <!-- Project Stats -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(108, 99, 255, 0.1); color: var(--primary);">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalProjects">${projects.length}</h3>
                            <p>Total Projects</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(78, 205, 196, 0.1); color: var(--secondary);">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="inProgressProjects">${projects.filter(p => p.status === 'In Progress').length}</h3>
                            <p>In Progress</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(40, 167, 69, 0.1); color: var(--success);">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="completedProjects">${projects.filter(p => p.status === 'Completed').length}</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="notStartedProjects">${projects.filter(p => p.status === 'Not Started').length}</h3>
                            <p>Not Started</p>
                        </div>
                    </div>
                </div>

                <!-- Projects Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Projects</h2>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Client</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Due Date</th>
                                    <th>Value</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody">
                                ${renderProjectsTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Add search functionality
            const searchInput = document.getElementById('projectSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterProjects(e.target.value.toLowerCase());
                });
            }
        }

        function renderProjectsTable() {
            if (!projects || projects.length === 0) return '';

            return projects.map(project => `
                <tr>
                    <td>
                        <div>
                            <strong>${project.projectName || 'N/A'}</strong>
                            <br><small style="color: var(--gray);">${project.description || 'No description'}</small>
                        </div>
                    </td>
                    <td>${project.clientName || 'N/A'}</td>
                    <td>${project.service || 'N/A'}</td>
                    <td><span class="status-badge status-${(project.status || 'Not Started').toLowerCase().replace(' ', '-')}">${project.status || 'Not Started'}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background: var(--light-gray); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${project.progress || 0}%; background: ${getProgressColor(project.progress || 0)}; height: 100%; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 12px; color: var(--gray);">${project.progress || 0}%</span>
                        </div>
                    </td>
                    <td>${project.dueDate || 'N/A'}</td>
                    <td>KSh ${(project.value || 0).toLocaleString()}</td>
                    <td>
                        <i class="fas fa-edit" style="color: var(--primary); cursor: pointer;" onclick="editProject(${project.id})" title="Edit Project"></i>
                    </td>
                </tr>
            `).join('');
        }

        function getProgressColor(progress) {
            if (progress === 100) return 'var(--success)';
            if (progress >= 50) return 'var(--primary)';
            if (progress > 0) return 'var(--warning)';
            return 'var(--gray)';
        }

        function filterProjects(searchTerm) {
            const rows = document.querySelectorAll('#projectsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function showAddProjectForm() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Add New Project</h1>
                    <button class="btn" onclick="showProjectsPage()" style="background: var(--gray); color: white;"><i class="fas fa-arrow-left"></i> Back to Projects</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Project Details</h2>
                    </div>
                    <form id="projectForm">
                        <div class="form-group">
                            <label for="projectName">Project Name</label>
                            <input type="text" class="form-control" id="projectName" placeholder="Enter project name" required>
                        </div>
                        <div class="form-group">
                            <label for="projectClient">Client</label>
                            <select class="form-control" id="projectClient" required>
                                <option value="">Select a client</option>
                                ${clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projectService">Service Type</label>
                            <select class="form-control" id="projectService" required>
                                <option value="">Select service type</option>
                                <option value="Logo Design">Logo Design</option>
                                <option value="Branding Package">Branding Package</option>
                                <option value="Web Design">Web Design</option>
                                <option value="Social Media Graphics">Social Media Graphics</option>
                                <option value="Print Design">Print Design</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projectDescription">Description</label>
                            <textarea class="form-control" id="projectDescription" rows="3" placeholder="Enter project description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="projectValue">Project Value</label>
                            <input type="number" class="form-control" id="projectValue" placeholder="Enter project value" required>
                        </div>
                        <div class="form-group">
                            <label for="projectStartDate">Start Date</label>
                            <input type="date" class="form-control" id="projectStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="projectDueDate">Due Date</label>
                            <input type="date" class="form-control" id="projectDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="projectStatus">Status</label>
                            <select class="form-control" id="projectStatus" required>
                                <option value="Not Started">Not Started</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projectProgress">Progress (%)</label>
                            <input type="range" class="form-control" id="projectProgress" min="0" max="100" value="0" oninput="document.getElementById('progressValue').textContent = this.value + '%'">
                            <span id="progressValue">0%</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Project</button>
                    </form>
                </div>
            `;

            // Set default start date to today
            document.getElementById('projectStartDate').value = new Date().toISOString().split('T')[0];

            // Handle form submission for new projects
            document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);
        }

        function handleProjectSubmit(e) {
            e.preventDefault();
            
            const selectedClientId = parseInt(document.getElementById('projectClient').value);
            const selectedClient = clients.find(c => c.id === selectedClientId);
            
            const projectData = {
                id: Date.now(),
                clientId: selectedClientId,
                clientName: selectedClient ? selectedClient.name : 'Unknown Client',
                projectName: document.getElementById('projectName').value,
                service: document.getElementById('projectService').value,
                status: document.getElementById('projectStatus').value,
                startDate: document.getElementById('projectStartDate').value,
                dueDate: document.getElementById('projectDueDate').value,
                progress: parseInt(document.getElementById('projectProgress').value),
                value: parseFloat(document.getElementById('projectValue').value) || 0,
                description: document.getElementById('projectDescription').value
            };

            // Validate form
            if (!projectData.projectName || !projectData.clientId || !projectData.service) {
                alert('Please fill in all required fields');
                return;
            }

            // Add project
            projects.push(projectData);
            saveData();
            
            // Show success message and return to projects page
            showNotification('Project added successfully!', 'success');
            showProjectsPage();
        }

        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            // Show the add project form first
            showAddProjectForm();
            
            // Wait a moment for the form to be rendered, then fill it
            setTimeout(() => {
                // Fill form with project data
                document.getElementById('projectName').value = project.projectName;
                document.getElementById('projectClient').value = project.clientId;
                document.getElementById('projectService').value = project.service;
                document.getElementById('projectDescription').value = project.description;
                document.getElementById('projectValue').value = project.value;
                document.getElementById('projectStartDate').value = project.startDate;
                document.getElementById('projectDueDate').value = project.dueDate;
                document.getElementById('projectStatus').value = project.status;
                document.getElementById('projectProgress').value = project.progress;
                document.getElementById('progressValue').textContent = project.progress + '%';

                // Update form to edit mode
                const submitBtn = document.querySelector('#projectForm button[type="submit"]');
                submitBtn.textContent = 'Update Project';
                
                // Remove existing event listener and add new one
                const form = document.getElementById('projectForm');
                form.removeEventListener('submit', handleProjectSubmit);
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    updateProject(id);
                });
            }, 100);
        }

        function updateProject(id) {
            const projectIndex = projects.findIndex(p => p.id === id);
            if (projectIndex === -1) return;

            const selectedClientId = parseInt(document.getElementById('projectClient').value);
            const selectedClient = clients.find(c => c.id === selectedClientId);

            projects[projectIndex] = {
                ...projects[projectIndex],
                clientId: selectedClientId,
                clientName: selectedClient ? selectedClient.name : 'Unknown Client',
                projectName: document.getElementById('projectName').value,
                service: document.getElementById('projectService').value,
                status: document.getElementById('projectStatus').value,
                startDate: document.getElementById('projectStartDate').value,
                dueDate: document.getElementById('projectDueDate').value,
                progress: parseInt(document.getElementById('projectProgress').value),
                value: parseFloat(document.getElementById('projectValue').value) || 0,
                description: document.getElementById('projectDescription').value
            };

            saveData();
            showProjectsPage();
            showNotification('Project updated successfully!', 'success');
        }

        function deleteProject(id) {
            if (confirm('Are you sure you want to delete this project?')) {
                projects = projects.filter(p => p.id !== id);
                saveData();
                showProjectsPage();
                showNotification('Project deleted successfully!', 'success');
            }
        }

        // Settings page
        function showSettings() {
            const mainContent = document.querySelector('.main-content');
            console.log('Rendering Settings page...');
            console.log('Main content element:', mainContent);
            
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Settings</h1>
                </div>
                
                <!-- Firebase Sync Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Cloud Backup & Sync</h2>
                        <p style="color: var(--gray); margin: 0;">Manage your data backup and synchronization with Firebase</p>
                    </div>
                    <div class="form-group">
                        <label>Firebase Status</label>
                        <div id="firebaseStatus" style="padding: 10px; border-radius: 8px; margin-bottom: 15px; background: #f8f9fa; border: 1px solid #e9ecef;">
                            <span id="statusText">Checking connection...</span>
                        </div>
                        <button class="btn" style="background: var(--info); color: white;" onclick="checkFirebaseStatusUI()">Check Status</button>
                    </div>
                    <div class="form-group">
                        <label><strong>Auto-Sync Settings</strong></label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Automatically sync data to Firebase when changes are made</p>
                        <div style="display: flex; gap: 8px; margin-top: 12px; align-items: center;">
                            <button class="btn" style="background: var(--success); color: white; padding: 8px 16px; font-size: 14px; border-radius: 6px; min-width: 120px;" onclick="enableFirebaseSync(); showNotification('Auto-sync enabled', 'success');">
                                <i class="fas fa-play" style="margin-right: 6px;"></i>Enable
                            </button>
                            <button class="btn" style="background: var(--danger); color: white; padding: 8px 16px; font-size: 14px; border-radius: 6px; min-width: 120px;" onclick="disableFirebaseSync(); showNotification('Auto-sync disabled', 'info');">
                                <i class="fas fa-pause" style="margin-right: 6px;"></i>Disable
                            </button>
                        </div>
                        <div id="autoSyncStatus" style="margin-top: 12px; padding: 8px 12px; border-radius: 6px; background: #f8f9fa; border: 1px solid #e9ecef; text-align: center; font-size: 14px;">
                            <span id="autoSyncText" style="font-weight: 500;">Auto-sync is disabled</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sync to Firebase</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Upload your current data to Firebase cloud storage</p>
                        <button class="btn btn-primary" onclick="syncToFirebaseUI()">
                            <i class="fas fa-cloud-upload-alt"></i> Sync to Firebase
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Restore from Firebase</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Download and restore your data from Firebase (overwrites current data)</p>
                        <button class="btn" style="background: var(--warning); color: white;" onclick="restoreFromFirebaseUI()">
                            <i class="fas fa-cloud-download-alt"></i> Restore from Firebase
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Sync from Firebase</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Download latest changes from Firebase (merges with current data)</p>
                        <button class="btn" style="background: var(--success); color: white;" onclick="syncFromFirebaseUI()">
                            <i class="fas fa-sync-alt"></i> Sync from Firebase
                        </button>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Data Management</h2>
                    </div>
                    <div class="form-group">
                        <label>Export Data</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Download a backup file of all your data</p>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-download"></i> Export All Data
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Import Data</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Upload a backup file to restore your data</p>
                        <input type="file" class="form-control" id="importFile" accept=".json">
                        <button class="btn btn-primary mt-20" onclick="importData()">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Refresh Data</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Reload data from storage to ensure you have the latest version</p>
                        <button class="btn" style="background: var(--info); color: white;" onclick="ensureDataConsistency(); showNotification('Data refreshed successfully!', 'success');">
                            <i class="fas fa-refresh"></i> Refresh Data
                        </button>
                    </div>
                </div>
                
                <!-- Debug Section -->
                <div class="card" style="background: #f0f8ff; border: 2px solid #007bff;">
                    <div class="card-header">
                        <h2 class="card-title">Debug Test</h2>
                    </div>
                    <div class="form-group">
                        <label>Test Settings Page</label>
                        <p style="color: var(--gray); font-size: 14px; margin: 5px 0;">Test if the Settings page is working correctly</p>
                        <button class="btn" style="background: #007bff; color: white;" onclick="testSettingsPage()">
                            <i class="fas fa-bug"></i> Test Settings
                        </button>
                    </div>
                </div>
            `;
            
            // Check Firebase status when settings page loads
            setTimeout(() => {
                checkFirebaseStatusUI();
                updateAutoSyncStatus();
            }, 500);
        }

        // Analytics page
        function showAnalytics() {
            const mainContent = document.querySelector('.main-content');
            const stats = calculateClientStats();
            
            // Calculate revenue by service type
            const revenueByService = calculateRevenueByService();
            
            // Calculate monthly revenue data
            const monthlyRevenue = calculateMonthlyRevenue();
            
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Analytics</h1>
                </div>

                <!-- Revenue Summary Cards -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(108, 99, 255, 0.1); color: var(--primary);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>KSh ${stats.totalRevenue.toLocaleString()}</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(40, 167, 69, 0.1); color: var(--success);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3>KSh ${stats.totalProjectValue.toLocaleString()}</h3>
                            <p>Total Project Value</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>KSh ${stats.pendingRevenue.toLocaleString()}</h3>
                            <p>Pending Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(78, 205, 196, 0.1); color: var(--secondary);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>${stats.totalClients}</h3>
                            <p>Total Clients</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row" style="margin-top: 30px;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Revenue by Service Type</h2>
                            </div>
                            <div class="card-body">
                                <canvas id="serviceRevenueChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Monthly Revenue</h2>
                            </div>
                            <div class="card-body">
                                <canvas id="monthlyRevenueChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Summary Table -->
                <div class="card" style="margin-top: 30px;">
                    <div class="card-header">
                        <h2 class="card-title">Revenue Summary</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Service Type</th>
                                        <th>Total Projects</th>
                                        <th>Total Value</th>
                                        <th>Revenue Collected</th>
                                        <th>Pending Revenue</th>
                                        <th>Completion Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${renderRevenueSummaryTable(revenueByService)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Initialize charts after DOM is updated
            setTimeout(() => {
                renderServiceRevenueChart(revenueByService);
                renderMonthlyRevenueChart(monthlyRevenue);
            }, 100);
        }





        // Calculate revenue by service type
        function calculateRevenueByService() {
            const serviceRevenue = {};
            
            clients.forEach(client => {
                const service = client.service || 'Unknown';
                if (!serviceRevenue[service]) {
                    serviceRevenue[service] = {
                        totalProjects: 0,
                        totalValue: 0,
                        revenueCollected: 0,
                        pendingRevenue: 0
                    };
                }
                
                serviceRevenue[service].totalProjects++;
                
                // Only include confirmed payments in revenue calculations
                if (client.paymentStatus !== 'pending') {
                serviceRevenue[service].totalValue += client.value || 0;
                serviceRevenue[service].revenueCollected += client.paidAmount || 0;
                serviceRevenue[service].pendingRevenue += (client.value || 0) - (client.paidAmount || 0);
                }
            });
            
            return serviceRevenue;
        }

        // Calculate monthly revenue data
        function calculateMonthlyRevenue() {
            const monthlyData = {};
            const currentDate = new Date();
            
            // Initialize last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[monthKey] = 0;
            }
            
            // Calculate revenue from monthly payments
            clients.forEach(client => {
                if (client.monthlyPayments && Array.isArray(client.monthlyPayments)) {
                    client.monthlyPayments.forEach(payment => {
                        const paymentDate = new Date(payment.date);
                        const monthKey = paymentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        if (monthlyData.hasOwnProperty(monthKey)) {
                            monthlyData[monthKey] += payment.amount || 0;
                        }
                    });
                }
            });
            
            return monthlyData;
        }

        // Render revenue summary table
        function renderRevenueSummaryTable(revenueByService) {
            return Object.entries(revenueByService).map(([service, data]) => {
                const completionRate = data.totalValue > 0 ? ((data.revenueCollected / data.totalValue) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td><strong>${service}</strong></td>
                        <td>${data.totalProjects}</td>
                        <td>KSh ${data.totalValue.toLocaleString()}</td>
                        <td class="text-success">KSh ${data.revenueCollected.toLocaleString()}</td>
                        <td class="text-warning">KSh ${data.pendingRevenue.toLocaleString()}</td>
                        <td>${completionRate}%</td>
                    </tr>
                `;
            }).join('');
        }

        // Render service revenue pie chart
        function renderServiceRevenueChart(revenueByService) {
            const ctx = document.getElementById('serviceRevenueChart');
            if (!ctx) return;
            
            const labels = Object.keys(revenueByService);
            const data = Object.values(revenueByService).map(service => service.revenueCollected);
            const colors = [
                '#6C63FF', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
            ];
            
            new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: KSh ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render monthly revenue bar chart
        function renderMonthlyRevenueChart(monthlyRevenue) {
            const ctx = document.getElementById('monthlyRevenueChart');
            if (!ctx) return;
            
            const labels = Object.keys(monthlyRevenue);
            const data = Object.values(monthlyRevenue);
            
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Revenue (KSh)',
                        data: data,
                        backgroundColor: 'rgba(108, 99, 255, 0.8)',
                        borderColor: 'rgba(108, 99, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSh ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Revenue: KSh ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportData() {
            const data = {
                clients: clients,
                prospects: prospects,
                projects: projects,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.clients && data.prospects) {
                        // Replace all existing data with imported data
                        clients = data.clients || [];
                        prospects = data.prospects || [];
                        projects = data.projects || [];
                        
                        // Save the imported data to localStorage
                        saveData();
                        
                        // Update the UI
                        updateStats();
                        
                        // Show success message
                        showNotification('Data imported successfully! All existing data has been replaced.', 'success');
                        
                        // Clear the file input
                        fileInput.value = '';
                        
                        // Refresh the current page to show the imported data
                        const currentPage = document.querySelector('.page-title');
                        if (currentPage) {
                            const pageTitle = currentPage.textContent;
                            switch(pageTitle) {
                                case 'Dashboard':
                                    showDashboard();
                                    break;
                                case 'Clients':
                                    showClients();
                                    break;
                                case 'Projects':
                                    showProjectsPage();
                                    break;
                                case 'Analytics':
                                    showAnalytics();
                                    break;
                                case 'Outreach':
                                    showOutreach();
                                    break;
                            }
                        }
                    } else {
                        alert('Invalid data format. Please make sure the file contains clients, prospects, and projects data.');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
                // Clear all data from localStorage
                localStorage.removeItem('clients');
                localStorage.removeItem('prospects');
                localStorage.removeItem('projects');
                
                // Clear all data arrays
                clients = [];
                prospects = [];
                projects = [];
                
                // Save empty data to localStorage
                saveData();
                
                // Show notification and refresh
                showNotification('All data has been reset successfully!', 'success');
                location.reload();
            }
        }


        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Mobile sidebar functions
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Close sidebar when menu item is clicked on mobile
        function handleMobileMenuClick() {
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }

        // Ensure data consistency across all views
        function ensureDataConsistency() {
            // Reload data from localStorage to ensure we have the latest
            const storedClients = localStorage.getItem('clients');
            const storedProspects = localStorage.getItem('prospects');
            const storedProjects = localStorage.getItem('projects');
            const storedInvoices = localStorage.getItem('invoices');
            
            clients = storedClients ? JSON.parse(storedClients) : [];
            prospects = storedProspects ? JSON.parse(storedProspects) : [];
            projects = storedProjects ? JSON.parse(storedProjects) : [];
            invoices = storedInvoices ? JSON.parse(storedInvoices) : [];
            
            // Ensure arrays are valid
            if (!Array.isArray(clients)) clients = [];
            if (!Array.isArray(prospects)) prospects = [];
            if (!Array.isArray(projects)) projects = [];
            if (!Array.isArray(invoices)) invoices = [];
            
            console.log('Data refreshed - Clients:', clients.length, 'Prospects:', prospects.length, 'Projects:', projects.length, 'Invoices:', invoices.length);
        }

        // Refresh data on window resize to ensure consistency between desktop and mobile
        function refreshDataOnResize() {
            // Ensure data is fresh
            ensureDataConsistency();
            
            // Get current page
            const currentPage = document.querySelector('.page-title');
            if (currentPage) {
                const pageTitle = currentPage.textContent;
                switch(pageTitle) {
                    case 'Dashboard':
                        showDashboard();
                        break;
                    case 'Clients':
                        showClients();
                        break;
                    case 'Projects':
                        showProjectsPage();
                        break;
                    case 'Analytics':
                        showAnalytics();
                        break;
                    case 'Outreach':
                        showOutreach();
                        break;
                    case 'Invoices':
                        showInvoices();
                        break;
                    case 'Settings':
                        showSettings();
                        break;
                }
            }
        }

        // Initialize the dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Initializing dashboard');
            await ensureDataInitialized();
            initializeSidebar();
            initializeTabs();
            initializeForms();
            initializeSearch();
            updateStats();
            console.log('Dashboard initialization complete');
        });

        // Add window resize listener to refresh data when switching between desktop and mobile
        window.addEventListener('resize', function() {
            // Debounce the resize event to avoid too many calls
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(refreshDataOnResize, 250);
        });

        // Add periodic data sync to ensure consistency
        setInterval(function() {
            ensureDataConsistency();
        }, 5000); // Sync every 5 seconds
    </script>
</body>
</html>